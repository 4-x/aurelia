(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@aurelia/jit"),require("@aurelia/runtime-html"),require("@aurelia/kernel"),require("@aurelia/runtime")):"function"==typeof define&&define.amd?define(["exports","@aurelia/jit","@aurelia/runtime-html","@aurelia/kernel","@aurelia/runtime"],e):e((t=t||self).jitHtml={},t.jit,t.runtimeHtml,t.kernel,t.runtime)})(this,function(t,jit,runtimeHtml,kernel,runtime){"use strict";function e(t){const e=t.index,{length:n,input:s}=t;for(;n>t.index&&58!==s.charCodeAt(++t.index););return s.slice(e,t.index).trim()}function n(t){++t.index;const{length:e,input:n}=t;let s="",i=0;for(;e>t.index;){switch(i=n.charCodeAt(t.index)){case 59:return++t.index,s.trim();case 47:i=n.charCodeAt(++t.index),s+=`\\${d(i)}`;break;case 39:s+="'";break;default:s+=d(i)}++t.index}return s.trim()}function stringifyDOM(t,e){let n=" ".repeat(e);if(n+=`Node: ${t.nodeName}`,3===t.nodeType&&(n+=` "${t.textContent}"`),1===t.nodeType){let e,s=0;const i=t.attributes,r=i.length;for(;r>s;++s)n+=` ${(e=i[s]).name}=${e.value}`}if(n+="\n",1===t.nodeType){let s=0,childNodes=t.childNodes,i=childNodes.length;for(;i>s;++s)n+=stringifyDOM(childNodes[s],e+1);if("TEMPLATE"===t.nodeName)for(s=0,i=(childNodes=t.content.childNodes).length;i>s;++s)n+=stringifyDOM(childNodes[s],e+1)}return n}function stringifyInstructions(t,e){let n=" ".repeat(e);switch(t.type){case"ha":n+="textBinding\n";break;case"rh":n+="callBinding\n";break;case"rk":n+="iteratorBinding\n";break;case"hb":n+="listenerBinding\n";break;case"rg":n+="propertyBinding\n";break;case"rj":n+="refBinding\n";break;case"hd":n+="stylePropertyBinding\n";break;case"re":n+="setProperty\n";break;case"he":n+="setAttribute\n";break;case"rf":n+="interpolation\n";break;case"rd":n+="hydrateLetElement\n",t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"rb":n+=`hydrateAttribute: ${t.res}\n`,t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"ra":n+=`hydrateElement: ${t.res}\n`,t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)});break;case"rc":n+=`hydrateTemplateController: ${t.res}\n`,n+=stringifyTemplateDefinition(t.def,e+1),t.instructions.forEach(t=>{n+=stringifyInstructions(t,e+1)})}return n}function stringifyTemplateDefinition(def,t){const e=" ".repeat(t);let n=e;return n+=`TemplateDefinition: ${def.name}\n`,n+=stringifyDOM(def.template,t+1),n+=`${e} Instructions:\n`,def.instructions.forEach(s=>{n+=`${e}  Row:\n`,s.forEach(e=>{n+=stringifyInstructions(e,t+3)})}),n}class TriggerBindingCommand{constructor(){this.t=86}compile(t){return new runtimeHtml.TriggerBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("trigger",TriggerBindingCommand);class DelegateBindingCommand{constructor(){this.t=88}compile(t){return new runtimeHtml.DelegateBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("delegate",DelegateBindingCommand);class CaptureBindingCommand{constructor(){this.t=87}compile(t){return new runtimeHtml.CaptureBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("capture",CaptureBindingCommand);class AttrBindingCommand{constructor(){this.t=32}compile(t){const e=jit.getTarget(t,0);return new runtimeHtml.AttributeBindingInstruction(e,t.s,e)}}jit.BindingCommandResource.i("attr",AttrBindingCommand);class StyleBindingCommand{constructor(){this.t=32}compile(t){return new runtimeHtml.AttributeBindingInstruction("style",t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("style",StyleBindingCommand);class ClassBindingCommand{constructor(){this.t=32}compile(t){return new runtimeHtml.AttributeBindingInstruction("class",t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("class",ClassBindingCommand);class s{l(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"attr")}o(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"attr")}}jit.attributePattern({pattern:"attr.PART",symbols:"."},{pattern:"PART.attr",symbols:"."})(s);class i{u(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"style")}m(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"style")}}jit.attributePattern({pattern:"style.PART",symbols:"."},{pattern:"PART.style",symbols:"."})(i);class r{p(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"class")}T(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"class")}}jit.attributePattern({pattern:"class.PART",symbols:"."},{pattern:"PART.class",symbols:"."})(r);const l=[].slice,{A:o,P:a}=kernel.Profiler.g("TemplateBinder"),c={id:1,k:1,v:1},u={B:1,k:1,v:1};class TemplateBinder{constructor(dom,t,e,n){this.dom=dom,this.R=t,this.C=e,this.M=n,this.$=null,this.manifest=null,this.L=null,this.j=null,this.N=null}bind(t){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bind",l.call(arguments)),kernel.Profiler.enabled&&o();const e=this.$,n=this.j,s=this.L,i=this.manifest,r=this.$=this.manifest=new jit.PlainElementSymbol(t),u=t.attributes;let d=0;for(;u.length>d;){const t=u[d],e=this.C.parse(t.name,t.value);if(1==c[e.target])throw kernel.Profiler.enabled&&a(),Error(`Invalid surrogate attribute: ${e.target}`);const n=this.R.q(e);if(null==n)this.S(e,t);else{if(n.isTemplateController)throw kernel.Profiler.enabled&&a(),Error("Cannot have template controller on surrogate element.");this.I(e,n)}++d}return this.O(t),this.$=e,this.j=n,this.L=s,this.manifest=i,kernel.Profiler.enabled&&a(),kernel.Tracer.enabled&&kernel.Tracer.P(),r}D(t,e){switch(kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindManifest",l.call(arguments)),e.nodeName){case"LET":return this.F(t,e),void(kernel.Tracer.enabled&&kernel.Tracer.P());case"SLOT":this.$.hasSlots=1}const n=this.j,s=this.L,i=this.manifest;this.N=e.getAttribute("part");let r=void 0,name=e.getAttribute("as-element");null==name&&(name=e.nodeName.toLowerCase());const o=this.R.G(name);null==o?this.manifest=new jit.PlainElementSymbol(e):(this.j=this.L,r=this.L=this.manifest=new jit.CustomElementSymbol(this.dom,e,o)),this.O(e),this.H(e,t),null!=r&&r.J?e.parentNode.replaceChild(r.marker,e):this.manifest.K&&e.classList.add("au"),this.j=n,this.L=s,this.manifest=i,kernel.Tracer.enabled&&kernel.Tracer.P()}F(t,e){const n=new jit.LetElementSymbol(this.dom,e);t.childNodes.push(n);const s=e.attributes;let i=0;for(;s.length>i;){const t=s[i];if("to-view-model"===t.name){e.removeAttribute("to-view-model"),n.toViewModel=1;continue}const r=this.C.parse(t.name,t.value),l=this.R.U(r),o=this.M.parse(r.V,null==l?2048:l.t),to=kernel.camelCase(r.target),a=new jit.BindableInfo(to,runtime.BindingMode.W);n.X.push(new jit.BindingSymbol(l,a,o,r.V,to)),++i}e.parentNode.replaceChild(n.marker,e)}H(t,e){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindAttributes",l.call(arguments));const{j:n,L:s,manifest:i}=this;let r=i;const o=this.Y(t);let a=void 0,c=void 0;const d=t.attributes;let f=0;for(;d.length>f;){const t=d[f];if(++f,1==u[t.name])continue;const e=this.C.parse(t.name,t.value),n=this.R.q(e);null==n?this.S(e,t):n.isTemplateController?(c=i.templateController=this.Z(e,n),r===i?(c.template=i,r=c):(c.templateController=a,c.template=a.template,a.template=c),a=c):this.I(e,n)}(function(dom,t,e){const n=e.tt;let s,i=t;for(;i!==e;)i.template===e?(n.parentNode.replaceChild(i.marker,n),"TEMPLATE"===n.nodeName?(i.tt=n,n.remove()):(s=i.tt=dom.et()).content.appendChild(n)):(s=i.tt=dom.et()).content.appendChild(i.marker),n.removeAttribute(i.st.nt),i=i.template})(this.dom,r,i),null==o?e.childNodes.push(r):(o.parent=e,o.template=r,(i===s?n:s).parts.push(o),null!=e.templateController&&e.templateController.parts.push(o),(function(dom,t,e){let n,s;"TEMPLATE"===(n=512&e.flags?e.marker:e.tt).nodeName?t.tt=n:(s=t.tt=dom.et()).content.appendChild(n)})(this.dom,o,r)),kernel.Tracer.enabled&&kernel.Tracer.P()}O(t){let e,n;for(kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindChildNodes",l.call(arguments)),e="TEMPLATE"===t.nodeName?t.content.firstChild:t.firstChild;null!=e;)switch(e.nodeType){case 1:n=e.nextSibling,this.D(this.manifest,e),e=n;break;case 3:e=this.it(e).nextSibling;break;case 4:case 7:case 8:case 10:e=e.nextSibling;break;case 9:case 11:e=e.firstChild}kernel.Tracer.enabled&&kernel.Tracer.P()}it(t){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindText",l.call(arguments));const e=this.M.parse(t.wholeText,2048);if(null!=e){const n=new jit.TextSymbol(this.dom,t,e);this.manifest.childNodes.push(n),(function(t){const e=t.tt,n=e.parentNode;for(;null!=e.nextSibling&&3===e.nextSibling.nodeType;)n.removeChild(e.nextSibling);e.textContent="",n.insertBefore(t.marker,e)})(n)}for(;null!=t.nextSibling&&3===t.nextSibling.nodeType;)t=t.nextSibling;return kernel.Tracer.enabled&&kernel.Tracer.P(),t}Z(t,e){let n;kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","declareTemplateController",l.call(arguments));const s=this.R.U(t);if(null==s&&e.rt)n=new jit.TemplateControllerSymbol(this.dom,t,e,this.N),this.N=null,this.lt(n,e,t.V);else{n=new jit.TemplateControllerSymbol(this.dom,t,e,this.N);const i=this.M.parse(t.V,null==s?2048:s.t);n.X.push(new jit.BindingSymbol(s,e.bindable,i,t.V,t.target)),this.N=null}return kernel.Tracer.enabled&&kernel.Tracer.P(),n}I(t,e){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindCustomAttribute",l.call(arguments));const n=this.R.U(t);let s;if(null==n&&e.rt)s=new jit.CustomAttributeSymbol(t,e),this.lt(s,e,t.V);else{s=new jit.CustomAttributeSymbol(t,e);const i=this.M.parse(t.V,null==n?2048:n.t);s.X.push(new jit.BindingSymbol(n,e.bindable,i,t.V,t.target))}this.manifest.attributes.push(s),this.manifest.K=1,kernel.Tracer.enabled&&kernel.Tracer.P()}lt(t,s,value){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindMultiAttribute",l.call(arguments));const i=(function(t){const s=[],i=new ParserState(t),r=i.length;let name,value;for(;r>i.index;){if(0===(name=e(i)).length)return s;value=n(i),s.push({name,value})}return s})(value);let r;for(let e=0,n=i.length;n>e;++e){const n=this.C.parse((r=i[e]).name,r.value),l=this.R.U(n),o=this.M.parse(n.V,null==l?2048:l.t);let bindable=s.bindables[n.target];void 0===bindable&&(bindable=s.bindables[n.target]=new jit.BindableInfo(n.target,runtime.BindingMode.W)),t.X.push(new jit.BindingSymbol(l,bindable,o,n.V,n.target))}kernel.Tracer.enabled&&kernel.Tracer.P()}S(t,e){if(kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","bindPlainAttribute",l.call(arguments)),0===t.V.length)return void(kernel.Tracer.enabled&&kernel.Tracer.P());const n=this.R.U(t),s=this.manifest,i=this.M.parse(t.V,null==n?2048:n.t);if(16&s.flags){const bindable=s.bindables[t.target];null!=bindable?(s.X.push(new jit.BindingSymbol(n,bindable,i,t.V,t.target)),s.K=1):null==i&&"ref"!==t.target||(s.attributes.push(new jit.PlainAttributeSymbol(t,n,i)),s.K=1)}else null!=i||"ref"===t.target?(s.attributes.push(new jit.PlainAttributeSymbol(t,n,i)),s.K=1):s===this.$&&s.attributes.push(new jit.PlainAttributeSymbol(t,n,i));null==n&&null!=i&&(e.value=""),kernel.Tracer.enabled&&kernel.Tracer.P()}Y(t){kernel.Tracer.enabled&&kernel.Tracer.A("TemplateBinder","declareReplacePart",l.call(arguments));const name=t.getAttribute("replace-part");if(null==name)return kernel.Tracer.enabled&&kernel.Tracer.P(),null;t.removeAttribute("replace-part");const e=new jit.ReplacePartSymbol(name);return this.O(t),kernel.Tracer.enabled&&kernel.Tracer.P(),e}}class ParserState{constructor(t){this.input=t,this.index=0,this.length=t.length}}const d=String.fromCharCode;var Char;(function(Char){Char[Char.ot=34]="DoubleQuote",Char[Char.at=39]="SingleQuote",Char[Char.ct=47]="Slash",Char[Char.ht=59]="Semicolon",Char[Char.ut=58]="Colon"})(Char||(Char={}));const ITemplateElementFactory=kernel.DI.ft("ITemplateElementFactory").dt(),{A:f,P:m}=kernel.Profiler.g("TemplateElementFactory"),p={};class b{constructor(dom){this.dom=dom,this.template=dom.et()}static register(t){return kernel.Registration.singleton(ITemplateElementFactory,this).register(t)}et(t){if(kernel.Profiler.enabled&&f(),"string"==typeof t){let e=p[t];if(void 0===e){const template=this.template;template.innerHTML=t;const n=template.content.firstElementChild;null==n||"TEMPLATE"!==n.nodeName||null!=n.nextElementSibling?(this.template=this.dom.et(),e=template):(template.content.removeChild(n),e=n),p[t]=e}return kernel.Profiler.enabled&&m(),e.cloneNode(1)}if("TEMPLATE"!==t.nodeName){const template=this.dom.et();return template.content.appendChild(t),kernel.Profiler.enabled&&m(),template}return null!=t.parentNode&&t.parentNode.removeChild(t),kernel.Profiler.enabled&&m(),t}}b.inject=[runtime.IDOM];const w=Object.freeze({required:0,compiler:"default"}),{A:T,P:A}=kernel.Profiler.g("TemplateCompiler");class y{constructor(t,e,n){this.pt=t,this.C=e,this.M=n,this.bt=null,this.parts=null}get name(){return"default"}static register(t){return kernel.Registration.singleton(runtime.ITemplateCompiler,this).register(t)}compile(dom,t,e){kernel.Profiler.enabled&&T();const n=new TemplateBinder(dom,new jit.ResourceModel(e),this.C,this.M),template=t.template=this.pt.et(t.template),s=n.bind(template);void 0!==t.instructions&&t.instructions!==kernel.PLATFORM.wt||(t.instructions=[]),1==s.hasSlots&&(t.hasSlots=1),this.bt=t.instructions,this.parts={};const i=s.attributes,r=i.length;if(r>0){let surrogates;void 0!==t.surrogates&&t.surrogates!==kernel.PLATFORM.wt||(t.surrogates=Array(r)),surrogates=t.surrogates;for(let t=0;r>t;++t)surrogates[t]=this.Tt(i[t])}return this.At(s),this.bt=null,this.parts=null,t.build=w,kernel.Profiler.enabled&&A(),t}At(t){if(8192&t.flags){const{childNodes}=t;let e;const n=childNodes.length;for(let t=0;n>t;++t)if(128&(e=childNodes[t]).flags)this.bt.push([new runtimeHtml.TextBindingInstruction(e.yt)]);else if(32&e.flags){const t=e.X,instructions=[];let n;const s=t.length;for(let e=0;s>e;++e)instructions[e]=new runtime.LetBindingInstruction((n=t[e]).s,n.target);this.bt.push([new runtime.LetElementInstruction(instructions,e.toViewModel)])}else this.Pt(e)}}gt(t){const e=this.kt(t,1);e[0]=new runtime.HydrateElementInstruction(t.res,this.Et(t),this.vt(t)),this.bt.push(e),this.At(t)}Bt(t){const e=this.kt(t,0);e.length>0&&this.bt.push(e),this.At(t)}Pt(t){switch(511&t.flags){case 16:this.gt(t);break;case 64:this.Bt(t);break;case 1:this.Rt(t)}}Rt(t){const e=this.Et(t),n=this.bt,s=this.bt=[];this.Pt(t.template),this.bt=n;const def={name:null==t.N?t.res:t.N,template:t.tt,instructions:s,build:w};let parts=void 0;if((16384&t.flags)>0){parts={};for(const e of t.parts)parts[e.name]=this.parts[e.name]}this.bt.push([new runtime.HydrateTemplateController(def,t.res,e,"else"===t.res,parts)])}Et(t){let e;if(4096&t.flags){const{X:n}=t,s=n.length;e=Array(s);let i=0;for(;s>i;++i)e[i]=this.Ct(n[i])}else e=kernel.PLATFORM.wt;return e}Ct(t){return null==t.command?null==t.s?new runtime.SetPropertyInstruction(t.V,t.bindable.Mt):new runtime.InterpolationInstruction(t.s,t.bindable.Mt):t.command.compile(t)}kt(t,e){let n;if(2048&t.flags){const{attributes:s}=t,i=s.length;n=Array(e+i);for(let t=0;i>t;++t)n[t+e]=this.Tt(s[t])}else n=e>0?Array(e):kernel.PLATFORM.wt;return n}$t(t){const e=this.Et(t);return new runtime.HydrateAttributeInstruction(t.res,e)}Lt(t){return null==t.command?null==t.s?new runtimeHtml.SetAttributeInstruction(t.st.V,t.st.target):new runtime.InterpolationInstruction(t.s,t.st.target):t.command.compile(t)}Tt(t){return"ref"===t.st.target?new runtime.RefBindingInstruction(t.st.V):4&t.flags?this.$t(t):this.Lt(t)}vt(t){let parts;if(16384&t.flags){parts={};const e=t.parts,n=e.length;let s,i,r;for(let t=0;n>t;++t)r=e[t],s=this.bt,i=this.bt=[],this.Pt(r.template),this.parts[r.name]=parts[r.name]={name:r.name,template:r.tt,instructions:i,build:w},this.bt=s}else parts=kernel.PLATFORM.jt;return parts}}y.inject=[ITemplateElementFactory,jit.IAttributeParser,runtime.IExpressionParser];const ITemplateCompilerRegistration=y,ITemplateElementFactoryRegistration=b,DefaultComponents=[ITemplateCompilerRegistration,ITemplateElementFactoryRegistration],P=[i,r,s],TriggerBindingCommandRegistration=TriggerBindingCommand,DelegateBindingCommandRegistration=DelegateBindingCommand,CaptureBindingCommandRegistration=CaptureBindingCommand,AttrBindingCommandRegistration=AttrBindingCommand,ClassBindingCommandRegistration=ClassBindingCommand,StyleBindingCommandRegistration=StyleBindingCommand,DefaultBindingLanguage=[TriggerBindingCommandRegistration,DelegateBindingCommandRegistration,CaptureBindingCommandRegistration,ClassBindingCommandRegistration,StyleBindingCommandRegistration,AttrBindingCommandRegistration],BasicConfiguration={register:t=>runtimeHtml.BasicConfiguration.register(t).register(...jit.DefaultComponents,...jit.DefaultBindingSyntax,...P,...jit.DefaultBindingLanguage,...DefaultComponents,...DefaultBindingLanguage),xt(){return this.register(kernel.DI.xt())}};t.AttrBindingCommand=AttrBindingCommand,t.AttrBindingCommandRegistration=AttrBindingCommandRegistration,t.BasicConfiguration=BasicConfiguration,t.CaptureBindingCommand=CaptureBindingCommand,t.CaptureBindingCommandRegistration=CaptureBindingCommandRegistration,t.ClassBindingCommand=ClassBindingCommand,t.ClassBindingCommandRegistration=ClassBindingCommandRegistration,t.DefaultBindingLanguage=DefaultBindingLanguage,t.DefaultComponents=DefaultComponents,t.DelegateBindingCommand=DelegateBindingCommand,t.DelegateBindingCommandRegistration=DelegateBindingCommandRegistration,t.ITemplateCompilerRegistration=ITemplateCompilerRegistration,t.ITemplateElementFactory=ITemplateElementFactory,t.ITemplateElementFactoryRegistration=ITemplateElementFactoryRegistration,t.StyleBindingCommand=StyleBindingCommand,t.StyleBindingCommandRegistration=StyleBindingCommandRegistration,t.TemplateBinder=TemplateBinder,t.TriggerBindingCommand=TriggerBindingCommand,t.TriggerBindingCommandRegistration=TriggerBindingCommandRegistration,t.stringifyDOM=stringifyDOM,t.stringifyInstructions=stringifyInstructions,t.stringifyTemplateDefinition=stringifyTemplateDefinition,Object.defineProperty(t,"Nt",{value:1})});
