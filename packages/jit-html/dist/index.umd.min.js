(function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports,require("@aurelia/jit"),require("@aurelia/runtime-html"),require("@aurelia/kernel"),require("@aurelia/runtime")):"function"==typeof define&&define.amd?define(["exports","@aurelia/jit","@aurelia/runtime-html","@aurelia/kernel","@aurelia/runtime"],e):e((t=t||self).jitHtml={},t.jit,t.runtimeHtml,t.kernel,t.runtime)})(this,function(t,jit,runtimeHtml,kernel,runtime){"use strict";function e(t){const e=t.index,{length:s,input:n}=t;for(;s>t.index&&58!==n.charCodeAt(++t.index););return n.slice(e,t.index).trim()}function s(t){++t.index;const{length:e,input:s}=t;let n="",i=0;for(;e>t.index;){switch(i=s.charCodeAt(t.index)){case 59:return++t.index,n.trim();case 47:i=s.charCodeAt(++t.index),n+=`\\${a(i)}`;break;case 39:n+="'";break;default:n+=a(i)}++t.index}return n.trim()}function stringifyDOM(t,e){let s=" ".repeat(e);if(s+=`Node: ${t.nodeName}`,3===t.nodeType&&(s+=` "${t.textContent}"`),1===t.nodeType){let e,n=0;const i=t.attributes,r=i.length;for(;r>n;++n)s+=` ${(e=i[n]).name}=${e.value}`}if(s+="\n",1===t.nodeType){let n=0,childNodes=t.childNodes,i=childNodes.length;for(;i>n;++n)s+=stringifyDOM(childNodes[n],e+1);if("TEMPLATE"===t.nodeName)for(n=0,i=(childNodes=t.content.childNodes).length;i>n;++n)s+=stringifyDOM(childNodes[n],e+1)}return s}function stringifyInstructions(t,e){let s=" ".repeat(e);switch(t.type){case"ha":s+="textBinding\n";break;case"rh":s+="callBinding\n";break;case"rk":s+="iteratorBinding\n";break;case"hb":s+="listenerBinding\n";break;case"rg":s+="propertyBinding\n";break;case"rj":s+="refBinding\n";break;case"hd":s+="stylePropertyBinding\n";break;case"re":s+="setProperty\n";break;case"he":s+="setAttribute\n";break;case"rf":s+="interpolation\n";break;case"rd":s+="hydrateLetElement\n",t.instructions.forEach(t=>{s+=stringifyInstructions(t,e+1)});break;case"rb":s+=`hydrateAttribute: ${t.res}\n`,t.instructions.forEach(t=>{s+=stringifyInstructions(t,e+1)});break;case"ra":s+=`hydrateElement: ${t.res}\n`,t.instructions.forEach(t=>{s+=stringifyInstructions(t,e+1)});break;case"rc":s+=`hydrateTemplateController: ${t.res}\n`,s+=stringifyTemplateDefinition(t.def,e+1),t.instructions.forEach(t=>{s+=stringifyInstructions(t,e+1)})}return s}function stringifyTemplateDefinition(def,t){const e=" ".repeat(t);let s=e;return s+=`TemplateDefinition: ${def.name}\n`,s+=stringifyDOM(def.template,t+1),s+=`${e} Instructions:\n`,def.instructions.forEach(n=>{s+=`${e}  Row:\n`,n.forEach(e=>{s+=stringifyInstructions(e,t+3)})}),s}class TriggerBindingCommand{constructor(){this.t=86}compile(t){return new runtimeHtml.TriggerBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("trigger",TriggerBindingCommand);class DelegateBindingCommand{constructor(){this.t=88}compile(t){return new runtimeHtml.DelegateBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("delegate",DelegateBindingCommand);class CaptureBindingCommand{constructor(){this.t=87}compile(t){return new runtimeHtml.CaptureBindingInstruction(t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("capture",CaptureBindingCommand);class AttrBindingCommand{constructor(){this.t=32}compile(t){const e=jit.getTarget(t,0);return new runtimeHtml.AttributeBindingInstruction(e,t.s,e)}}jit.BindingCommandResource.i("attr",AttrBindingCommand);class StyleBindingCommand{constructor(){this.t=32}compile(t){return new runtimeHtml.AttributeBindingInstruction("style",t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("style",StyleBindingCommand);class ClassBindingCommand{constructor(){this.t=32}compile(t){return new runtimeHtml.AttributeBindingInstruction("class",t.s,jit.getTarget(t,0))}}jit.BindingCommandResource.i("class",ClassBindingCommand);class n{l(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"attr")}o(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"attr")}}jit.attributePattern({pattern:"attr.PART",symbols:"."},{pattern:"PART.attr",symbols:"."})(n);class i{h(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"style")}u(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"style")}}jit.attributePattern({pattern:"style.PART",symbols:"."},{pattern:"PART.style",symbols:"."})(i);class r{m(t,e,parts){return new jit.AttrSyntax(t,e,parts[1],"class")}p(t,e,parts){return new jit.AttrSyntax(t,e,parts[0],"class")}}jit.attributePattern({pattern:"class.PART",symbols:"."},{pattern:"PART.class",symbols:"."})(r),kernel.Profiler.T("TemplateBinder");const l={id:1,A:1,P:1},o={g:1,A:1,P:1};class TemplateBinder{constructor(dom,t,e,s){this.dom=dom,this.k=t,this.R=e,this.v=s,this.C=null,this.manifest=null,this.$=null,this.B=null,this.L=null}bind(t){const e=this.C,s=this.B,n=this.$,i=this.manifest,r=this.C=this.manifest=new jit.PlainElementSymbol(t),o=t.attributes;let c=0;for(;o.length>c;){const t=o[c],e=this.R.parse(t.name,t.value);if(1==l[e.target])throw Error(`Invalid surrogate attribute: ${e.target}`);const s=this.k.M(e);if(null===s)this.j(e,t);else{if(s.isTemplateController)throw Error("Cannot have template controller on surrogate element.");this.q(e,s)}++c}return this.N(t),this.C=e,this.B=s,this.$=n,this.manifest=i,r}S(t,e){switch(e.nodeName){case"LET":return void this.I(t,e);case"SLOT":return void(this.C.hasSlots=1)}const s=this.B,n=this.$,i=this.manifest;let r;this.L=e.getAttribute("part");let name=e.getAttribute("as-element");null===name&&(name=e.nodeName.toLowerCase());const l=this.k.O(name);null===l?this.manifest=new jit.PlainElementSymbol(e):(this.B=this.$,r=this.$=this.manifest=new jit.CustomElementSymbol(this.dom,e,l)),this.N(e),this.D(e,t),void 0!==r&&r.F?e.parentNode.replaceChild(r.marker,e):this.manifest._&&e.classList.add("au"),this.B=s,this.$=n,this.manifest=i}I(t,e){const s=new jit.LetElementSymbol(this.dom,e);t.childNodes.push(s);const n=e.attributes;let i=0;for(;n.length>i;){const t=n[i];if("to-view-model"===t.name){e.removeAttribute("to-view-model"),s.toViewModel=1;continue}const r=this.R.parse(t.name,t.value),l=this.k.G(r),o=this.v.parse(r.H,null===l?2048:l.t),to=kernel.PLATFORM.J(r.target),c=new jit.BindableInfo(to,runtime.BindingMode.K);s.U.push(new jit.BindingSymbol(l,c,o,r.H,to)),++i}e.parentNode.replaceChild(s.marker,e)}D(t,e){const{B:s,$:n,manifest:i}=this;let r=i;const l=this.V(t);let c,a;const h=t.attributes;let u=0;for(;h.length>u;){const t=h[u];if(++u,1==o[t.name])continue;const e=this.R.parse(t.name,t.value),s=this.k.M(e);null===s?this.j(e,t):s.isTemplateController?(a=i.templateController=this.W(e,s),r===i?(a.template=i,r=a):(a.templateController=c,a.template=c.template,c.template=a),c=a):this.q(e,s)}(function(dom,t,e){const s=e.X;let n,i=t;for(;i!==e;)i.template===e?(s.parentNode.replaceChild(i.marker,s),"TEMPLATE"===s.nodeName?(i.X=s,s.remove()):(n=i.X=dom.Y()).content.appendChild(s)):(n=i.X=dom.Y()).content.appendChild(i.marker),s.removeAttribute(i.tt.Z),i=i.template})(this.dom,r,i),null===l?e.childNodes.push(r):(l.parent=e,l.template=r,(i===n?s:n).parts.push(l),(function(dom,t,e){let s,n;"TEMPLATE"===(s=512&e.flags?e.marker:e.X).nodeName?t.X=s:(n=t.X=dom.Y()).content.appendChild(s)})(this.dom,l,r))}N(t){let e,s;for(e="TEMPLATE"===t.nodeName?t.content.firstChild:t.firstChild;null!==e;)switch(e.nodeType){case 1:s=e.nextSibling,this.S(this.manifest,e),e=s;break;case 3:e=this.et(e).nextSibling;break;case 4:case 7:case 8:case 10:e=e.nextSibling;break;case 9:case 11:e=e.firstChild}}et(t){const e=this.v.parse(t.wholeText,2048);if(null!==e){const s=new jit.TextSymbol(this.dom,t,e);this.manifest.childNodes.push(s),(function(t){const e=t.X,s=e.parentNode;for(;null!==e.nextSibling&&3===e.nextSibling.nodeType;)s.removeChild(e.nextSibling);e.textContent="",s.insertBefore(t.marker,e)})(s)}for(;null!==t.nextSibling&&3===t.nextSibling.nodeType;)t=t.nextSibling;return t}W(t,e){let s;const n=this.k.G(t);if(null===n&&e.st)s=new jit.TemplateControllerSymbol(this.dom,t,e,this.L),this.L=null,this.nt(s,e,t.H);else{s=new jit.TemplateControllerSymbol(this.dom,t,e,this.L);const i=this.v.parse(t.H,null===n?2048:n.t);s.U.push(new jit.BindingSymbol(n,e.bindable,i,t.H,t.target)),this.L=null}return s}q(t,e){const s=this.k.G(t);let n;if(null===s&&e.st)n=new jit.CustomAttributeSymbol(t,e),this.nt(n,e,t.H);else{n=new jit.CustomAttributeSymbol(t,e);const i=this.v.parse(t.H,null===s?2048:s.t);n.U.push(new jit.BindingSymbol(s,e.bindable,i,t.H,t.target))}this.manifest.attributes.push(n),this.manifest._=1}nt(t,n,value){const i=(function(t){const n=[],i=new c(t),r=i.length;let name,value;for(;r>i.index;){if(0===(name=e(i)).length)return n;value=s(i),n.push({name,value})}return n})(value);let r;for(let e=0,s=i.length;s>e;++e){const s=this.R.parse((r=i[e]).name,r.value),l=this.k.G(s),o=this.v.parse(s.H,null===l?2048:l.t);let bindable=n.bindables[s.target];void 0===bindable&&(bindable=n.bindables[s.target]=new jit.BindableInfo(s.target,runtime.BindingMode.K)),t.U.push(new jit.BindingSymbol(l,bindable,o,s.H,s.target))}}j(t,e){if(0===t.H.length)return;const s=this.k.G(t),n=this.manifest,i=this.v.parse(t.H,null===s?2048:s.t);if(16&n.flags){const bindable=n.bindables[t.target];void 0!==bindable?(n.U.push(new jit.BindingSymbol(s,bindable,i,t.H,t.target)),n._=1):null===i&&"ref"!==t.target||(n.attributes.push(new jit.PlainAttributeSymbol(t,s,i)),n._=1)}else null!==i||"ref"===t.target?(n.attributes.push(new jit.PlainAttributeSymbol(t,s,i)),n._=1):n===this.C&&n.attributes.push(new jit.PlainAttributeSymbol(t,s,i));null===s&&null!==i&&(e.value="")}V(t){const name=t.getAttribute("replace-part");return null===name?null:(t.removeAttribute("replace-part"),new jit.ReplacePartSymbol(name))}}class c{constructor(t){this.input=t,this.index=0,this.length=t.length}}const a=String.fromCharCode;var h;(function(t){t[t.it=34]="DoubleQuote",t[t.rt=39]="SingleQuote",t[t.lt=47]="Slash",t[t.ot=59]="Semicolon",t[t.ct=58]="Colon"})(h||(h={}));const ITemplateElementFactory=kernel.DI.ht("ITemplateElementFactory").at();kernel.Profiler.T("TemplateElementFactory");class u{constructor(dom){this.dom=dom,this.template=dom.Y()}static register(t){return kernel.Registration.singleton(ITemplateElementFactory,this).register(t)}Y(t){if("string"==typeof t){const template=this.template;template.innerHTML=t;const e=template.content.firstElementChild;return null===e||"TEMPLATE"!==e.nodeName||null!==e.nextElementSibling?(this.template=this.dom.Y(),template):(template.content.removeChild(e),e)}if("TEMPLATE"!==t.nodeName){const template=this.dom.Y();return template.content.appendChild(t),template}return null!==t.parentNode&&t.parentNode.removeChild(t),t}}u.inject=[runtime.IDOM];const f=Object.freeze({required:0,compiler:"default"});kernel.Profiler.T("TemplateCompiler");class m{constructor(t,e,s){this.ut=t,this.R=e,this.v=s,this.ft=null}get name(){return"default"}static register(t){return kernel.Registration.singleton(runtime.ITemplateCompiler,this).register(t)}compile(dom,t,e){const s=new TemplateBinder(dom,new jit.ResourceModel(e),this.R,this.v),template=t.template=this.ut.Y(t.template),n=s.bind(template);void 0!==t.instructions&&t.instructions!==kernel.PLATFORM.pt||(t.instructions=[]),1==n.hasSlots&&(t.hasSlots=1),this.ft=t.instructions;const i=n.attributes,r=i.length;if(r>0){let surrogates;void 0!==t.surrogates&&t.surrogates!==kernel.PLATFORM.pt||(t.surrogates=Array(r)),surrogates=t.surrogates;for(let t=0;r>t;++t)surrogates[t]=this.dt(i[t])}return this.bt(n),this.ft=null,t}bt(t){if(8192&t.flags){const{childNodes}=t;let e;const s=childNodes.length;for(let t=0;s>t;++t)if(128&(e=childNodes[t]).flags)this.ft.push([new runtimeHtml.TextBindingInstruction(e.wt)]);else if(32&e.flags){const t=e.U,instructions=[];let s;const n=t.length;for(let e=0;n>e;++e)instructions[e]=new runtime.LetBindingInstruction((s=t[e]).s,s.target);this.ft.push([new runtime.LetElementInstruction(instructions,e.toViewModel)])}else this.Tt(e)}}yt(t){const e=this.At(t,1);e[0]=new runtime.HydrateElementInstruction(t.res,this.Pt(t),this.gt(t)),this.ft.push(e)}kt(t){const e=this.At(t,0);e.length>0&&this.ft.push(e),this.bt(t)}Tt(t){switch(511&t.flags){case 16:this.yt(t);break;case 64:this.kt(t);break;case 1:this.Et(t)}}Et(t){const e=this.Pt(t),s=this.ft,n=this.ft=[];this.Tt(t.template),this.ft=s,this.ft.push([new runtime.HydrateTemplateController({name:null===t.L?t.res:t.L,template:t.X,instructions:n,build:f},t.res,e,"else"===t.res)])}Pt(t){let e;if(4096&t.flags){const{U:s}=t,n=s.length;e=Array(n);let i=0;for(;n>i;++i)e[i]=this.Rt(s[i])}else e=kernel.PLATFORM.pt;return e}Rt(t){return null===t.command?null===t.s?new runtime.SetPropertyInstruction(t.H,t.bindable.vt):new runtime.InterpolationInstruction(t.s,t.bindable.vt):t.command.compile(t)}At(t,e){let s;if(2048&t.flags){const{attributes:n}=t,i=n.length;s=Array(e+i);for(let t=0;i>t;++t)s[t+e]=this.dt(n[t])}else s=e>0?Array(e):kernel.PLATFORM.pt;return s}Ct(t){const e=this.Pt(t);return new runtime.HydrateAttributeInstruction(t.res,e)}$t(t){return null===t.command?null===t.s?new runtimeHtml.SetAttributeInstruction(t.tt.H,t.tt.target):new runtime.InterpolationInstruction(t.s,t.tt.target):t.command.compile(t)}dt(t){return"ref"===t.tt.target?new runtime.RefBindingInstruction(t.tt.H):4&t.flags?this.Ct(t):this.$t(t)}gt(t){let parts;if(16384&t.flags){parts={};const e=t.parts,s=e.length;let n,i,r;for(let t=0;s>t;++t)r=e[t],n=this.ft,i=this.ft=[],this.Tt(r.template),parts[r.name]={name:r.name,template:r.X,instructions:i,build:f},this.ft=n}else parts=kernel.PLATFORM.Bt;return parts}}m.inject=[ITemplateElementFactory,jit.IAttributeParser,runtime.IExpressionParser];const ITemplateCompilerRegistration=m,ITemplateElementFactoryRegistration=u,DefaultComponents=[ITemplateCompilerRegistration,ITemplateElementFactoryRegistration],p=[i,r,n],TriggerBindingCommandRegistration=TriggerBindingCommand,DelegateBindingCommandRegistration=DelegateBindingCommand,CaptureBindingCommandRegistration=CaptureBindingCommand,AttrBindingCommandRegistration=AttrBindingCommand,ClassBindingCommandRegistration=ClassBindingCommand,StyleBindingCommandRegistration=StyleBindingCommand,DefaultBindingLanguage=[TriggerBindingCommandRegistration,DelegateBindingCommandRegistration,CaptureBindingCommandRegistration,ClassBindingCommandRegistration,StyleBindingCommandRegistration,AttrBindingCommandRegistration],BasicConfiguration={register:t=>runtimeHtml.BasicConfiguration.register(t).register(...jit.DefaultComponents,...jit.DefaultBindingSyntax,...p,...jit.DefaultBindingLanguage,...DefaultComponents,...DefaultBindingLanguage),Lt(){return this.register(kernel.DI.Lt())}};t.AttrBindingCommand=AttrBindingCommand,t.AttrBindingCommandRegistration=AttrBindingCommandRegistration,t.BasicConfiguration=BasicConfiguration,t.CaptureBindingCommand=CaptureBindingCommand,t.CaptureBindingCommandRegistration=CaptureBindingCommandRegistration,t.ClassBindingCommand=ClassBindingCommand,t.ClassBindingCommandRegistration=ClassBindingCommandRegistration,t.DefaultBindingLanguage=DefaultBindingLanguage,t.DefaultComponents=DefaultComponents,t.DelegateBindingCommand=DelegateBindingCommand,t.DelegateBindingCommandRegistration=DelegateBindingCommandRegistration,t.ITemplateCompilerRegistration=ITemplateCompilerRegistration,t.ITemplateElementFactory=ITemplateElementFactory,t.ITemplateElementFactoryRegistration=ITemplateElementFactoryRegistration,t.StyleBindingCommand=StyleBindingCommand,t.StyleBindingCommandRegistration=StyleBindingCommandRegistration,t.TemplateBinder=TemplateBinder,t.TriggerBindingCommand=TriggerBindingCommand,t.TriggerBindingCommandRegistration=TriggerBindingCommandRegistration,t.stringifyDOM=stringifyDOM,t.stringifyInstructions=stringifyInstructions,t.stringifyTemplateDefinition=stringifyTemplateDefinition,Object.defineProperty(t,"Mt",{value:1})});
