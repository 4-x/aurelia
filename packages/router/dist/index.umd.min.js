(function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports,require("@aurelia/kernel"),require("@aurelia/runtime"),require("@aurelia/runtime-html")):"function"==typeof define&&define.amd?define(["exports","@aurelia/kernel","@aurelia/runtime","@aurelia/runtime-html"],s):s((t=t||self).router={},t.kernel,t.runtime,t.runtimeHtml)})(this,function(t,kernel,runtime,runtimeHtml){"use strict";function s(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const e=t.replace("+"," ").split("&");for(const t of e){const e=t.split("="),n=decodeURIComponent(e.shift());if(!e.length){i.push(n);continue}const value=decodeURIComponent(e.shift());s[n]=value}return{t:s,list:i}}function i(t,i,e){const n=s(i),r=s(t),o={...n.t,...r.t},l=[...n.list,...r.list];if(l.length&&e&&e.length)for(const t of e)o[t]=l.shift();let a;return l.length&&Object.keys(o).length&&(o["s"]=l.splice(0,l.length)),{i:o,o:l,l:a=l.length?l:o}}function e(t,s,i,e){var n,r,o=arguments.length,l=3>o?s:null===e?e=Object.getOwnPropertyDescriptor(s,i):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)l=Reflect.decorate(t,s,i,e);else for(r=t.length-1;r>=0;r--)(n=t[r])&&(l=(3>o?n(l):o>3?n(s,i,l):n(s,i))||l);return o>3&&l&&Object.defineProperty(s,i,l),l}class n{constructor(t){this.u=(async t=>this.p(this,"popstate",[t])),this.v=t,this.m=[],this.g=0,this.$=null,this.C=null,this.P=null,this.S=null}V(t){if(this.g)throw kernel.Reporter.error(2003);this.g=1,this.C=t,this.v.k(this.R,this,4096),runtimeHtml.DOM.window.addEventListener("popstate",this.u)}I(){runtimeHtml.DOM.window.removeEventListener("popstate",this.u),this.v.H(this.R,this),this.C=null,this.g=0}get length(){return runtimeHtml.DOM.window.history.length}get state(){return runtimeHtml.DOM.window.history.state}get A(){return runtimeHtml.DOM.window.history.A}async go(t,s=0){if(!s)return this.p(this,"_go",[t],1);const i=this.p(this,"suppressPopstate",[],1);return this.p(runtimeHtml.DOM.window.history,"go",[t]).catch(t=>{throw t}),i}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){return this.p(runtimeHtml.DOM.window.history,"pushState",[t,s,i])}async replaceState(t,s,i){return this.p(runtimeHtml.DOM.window.history,"replaceState",[t,s,i])}async N(t){if(this.S){const t=this.S;this.S=null,t()}else{if(this.P){const t=this.P;this.P=null,t(),await Promise.resolve()}this.C(t)}}O(t,s){this.P=s,runtimeHtml.DOM.window.history.go(t)}T(t){this.S=t}p(t,s,i,e=0){let n;const r=new Promise(t=>{n=t});return e&&(i.push(n),n=null),this.m.push({target:t,q:s,t:i,resolve:n}),r}async R(t){if(!this.m.length||null!==this.$)return;this.$=this.m.shift();const s=this.$.target[this.$.q];kernel.Reporter.write(1e4,"DEQUEUE",this.$.q,this.$.t),s.apply(this.$.target,this.$.t);const i=this.$.resolve;this.$=null,i&&i()}}n.inject=[runtime.ILifecycle];class r{constructor(t){this.j=(async()=>{const t=this.U(),s=this.L();kernel.Reporter.write(1e4,"path changed to",t,this.D,this.J);const i={};let e,n=this.B("HistoryEntry");if(this.D&&this.D.path===t){i.F=1;const t=this.G?this.J.index:this.history.length-this.M;e=this.J,this.J=this.D,this.J.index=t,this.G?(this.W=0,this.K[this.J.index]=this.J,this.X?(i.Y=1,this.X=0):i.Z=1,this.G=0):(this.W=1,this.K=this.K.slice(0,this.J.index),this.K.push(this.J)),await this.tt({st:this.K,it:this.M,ht:this.J})}else this.K=this.K||this.B("HistoryEntries")||[],this.M=this.M||this.B("HistoryOffset")||0,n||this.J?n?this.J?n.index>this.J.index?i.et=1:this.J.index>n.index&&(i.nt=1):i.Y=1:i.F=1:(i.F=1,i.rt=1,this.M=this.history.length),n||(n={path:t,ot:null,index:this.history.length-this.M,lt:s},i.rt&&(n.at=1),this.K=this.K.slice(0,n.index),this.K.push(n),await this.tt({st:this.K,it:this.M,ht:n})),this.W=this.J?n.index-this.J.index:0,e=this.J,this.J=n;this.D=null,kernel.Reporter.write(1e4,"navigated",this.B("HistoryEntry"),this.K,this.B("HistoryOffset")),this.C(this.J,i,e)}),this.history=new n(t),this.J=null,this.K=null,this.M=null,this.ct=null,this.D=null,this.options=null,this.g=0,this.W=null,this.G=0,this.X=0}V(t){if(this.g)throw kernel.Reporter.error(0);return this.g=1,this.options={...t},this.history.V(this.j),Promise.resolve().then(()=>{this.ut(this.U(),1).catch(t=>{throw t})})}I(){this.history.I(),this.g=0}ft(t,s,i){return this.D={path:t,ot:null,title:s,data:i},this.ut(t)}replace(t,s,i){return this.G=1,this.D={path:t,ot:null,title:s,data:i},this.ut(t,1)}async refresh(){if(this.J)return this.X=1,this.replace(this.J.path,this.J.title,this.J.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){const t=this.W;return t?(this.W=0,this.history.go(-t,1)):this.replace(this.ct.path,this.ct.title,this.ct.data)}async pop(){await this.history.go(-1,1);const t=""+this.location,s=this.history.state;if(!s.ht.at)return await this.history.go(-1,1),this.history.pushState(s,null,t)}async tt(t,value){const{pathname:s,search:i,hash:e}=this.location;let n={...this.history.state};return"string"==typeof t?n[t]=JSON.parse(JSON.stringify(value)):n={...n,...JSON.parse(JSON.stringify(t))},this.history.replaceState(n,null,`${s}${i}${e}`)}B(t){return{...this.history.state}[t]}pt(t){return this.J.title=t,this.K[this.J.index]=this.J,this.tt({st:this.K,ht:this.J})}dt(t,s,i){if(i.index!==this.J.index)return;const e=`#${t}`,{pathname:n,search:r,hash:o}=this.location;if(e===o&&this.J.path===t&&this.J.ot===s)return;this.J.path=t,this.J.ot=s;const l={...this.history.state,ht:this.J,st:this.K};return this.history.replaceState(l,null,`${n}${r}${e}`)}wt(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get vt(){return this.K?this.K.slice(0,this.J.index+1).map(value=>value.title):[]}U(){return this.location.hash.substring(1).split("?")[0]}async ut(t,s=0){const{pathname:i,search:e}=this.location,n=`#${t}`;return s?(this.ct=this.J,await this.history.replaceState({},null,`${i}${e}${n}`)):await this.history.pushState({},null,`${i}${e}${n}`),this.j()}L(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}C(t,s,i){const e={...t,...s};e.gt=i,kernel.Reporter.write(1e4,"callback",t,s),this.options.C&&this.options.C(e)}}r.inject=[runtime.ILifecycle];class o{constructor(){this.g=0,this.yt=(t=>{const s=o.$t(t);s.bt&&(t.preventDefault(),this.options.C(s))})}static $t(t){const s={bt:0,href:null,anchor:null},i=o.Ct(t.target);if(!i||!o.Pt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.bt=1===t.which,s}static Ct(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static Pt(t){const s=t.getAttribute("target");return!s||s===runtimeHtml.DOM.window.name||"_self"===s}V(t){if(this.g)throw kernel.Reporter.error(2004);this.g=1,this.options={...t},runtimeHtml.DOM.document.addEventListener("click",this.yt,1)}I(){runtimeHtml.DOM.document.removeEventListener("click",this.yt,1),this.g=0}}class l{constructor(component,t,s,i=0,e=null){this.component=null,this.Et=null,this.viewport=null,this.St=null,this.Vt=null,this.t=null,this.kt=null,this.Rt(component),this.It(t),this.Ht(s),this.At=i,this.Nt=e}Rt(component){"string"==typeof component?(this.Et=component,this.component=null):(this.component=component,this.Et=component.description.name)}It(t){void 0!==t&&""!==t||(t=null),"string"==typeof t?(this.St=t,this.viewport=null):(this.viewport=t,null!==t&&(this.St=t.name))}Ht(t){void 0!==t&&""!==t||(t=null),"string"==typeof t?(this.Vt=t,this.t={id:t}):this.t=t}Ot(t){if(null!==this.component)return this.component;const s=t.get(kernel.IContainer),i=s.xt(runtime.CustomElementResource.Tt(this.Et));return null!==i?i.jt(s).qt:null}Ut(router){return null!==this.viewport?this.viewport:router._t()[this.St]}Lt(t,s=0,i=0){return s&&this.Vt!==t.Vt?0:i?this.component===t.component:this.Et===t.Et}}class a{constructor(t,s){this.active="",this.Dt=t,Object.assign(this,{title:s.title,children:null,zt:s.zt,active:""}),this.instructions=this.Jt(s.Bt),this.link=this.Ft(this.instructions),this.Gt=s.Mt?this.Ft(this.Jt(s.Mt)):this.link,this.Qt=this.Dt.router.Wt.get(runtime.IObserverLocator),this.Kt=this.Qt.Xt(0,this.Dt.router,"activeComponents"),this.Kt.subscribe(this)}get Yt(){return this.children&&this.children.length?"nav-has-children":""}Zt(){this.active=this.link&&this.link.length?this.ts():"nav-active"===this.active?"nav-active":this.ss()?"nav-active-child":""}ts(){const t=this.Dt.router.es.hs(this.Gt),s=this.Dt.router.ns.map(t=>this.Dt.router.es.rs(t));for(const component of t)if(!s.find(t=>t.Lt(component)))return"";return"nav-active"}os(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}Ft(instructions){return this.Dt.router.es.ls(instructions)}Jt(t){if(!Array.isArray(t))return this.Jt([t]);const instructions=[];for(const s of t)instructions.push("string"==typeof s?this.Dt.router.es.rs(s):s instanceof l?s:s.component?new l(s.component,s.viewport,s.t):new l(s));return instructions}ss(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.ss())return 1;return 0}}class c{constructor(router,name,t=[]){this.router=router,this.name=name,this.as=t}cs(t){for(const s of t)this.us(this.as,s)}us(t,s){const i=new a(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.us(i.children,t)}}}class u{constructor(t,s){this.yt=t,this.names=s}}class f{constructor(t,s){this.fs=t,this.ps=s}}class p{constructor(){this.ds=0,this.ws=0,this.vs=0}}class d{constructor(t,s,i){this.yt=t,this.ms=s,this.gs=i}}class w{constructor(t,s,i){this.ys=t,this.$s=s,this.repeat=i}bs(t){return this.$s===t.$s&&this.ys===t.ys}}class State{constructor(t){this.Cs=t,this.Ps=[]}put(t){let s=this.Ps.find(s=>s.Cs.bs(t));return void 0===s&&(s=new State(t),this.Ps.push(s),t.repeat&&s.Ps.push(s)),s}}const v=/(\/|\.|\*|\+|\?|\||\(|\)|\[|\]|\{|\}|\\)/g;class m{constructor(t,s){this.name=t,this.Es=t,this.Ss=s,this.optional=0}Vs(t){const s=this.Es,i=s.length;let e=0,n="";if(this.Ss)for(;i>e;++e)n=s.charAt(e),t(new w(null,n,0));else for(;i>e;++e)n=s.charAt(e),t(new w(null,n.toUpperCase()+n.toLowerCase(),0))}ks(){return this.Es.replace(v,"\\$1")}Rs(t,s){return this.Es}}class g{constructor(name,optional){this.name=name,this.optional=optional}Vs(t){t(new w("/",null,1))}ks(){return"([^/]+)"}Rs(t,s){return s[this.name]=1,t[this.name]}}class y{constructor(name){this.name=name,this.optional=0}Vs(t){t(new w("",null,1))}ks(){return"(.+)"}Rs(t,s){return s[this.name]=1,t[this.name]}}class ${Vs(t){}ks(){return""}Rs(t,s){return""}}class b{constructor(){this.Is=(t=>t),this.Hs=(instructions=>instructions)}}var C,P;(C=t.As||(t.As={}))[C.Ns=0]="none",C[C.Os=1]="created",C[C.loaded=2]="loaded",C[C.xs=3]="initialized",C[C.Ts=4]="added",(P=t.qs||(t.qs={})).default="default",P.js="disallow",P.Us="enter",P.refresh="refresh";class E{constructor(t=null,s=null,i=null,e=null){this.content=t,this.t=s,this._s=i,this.component=null,this.Ls=0,this.Ds=0,this.zs=0,this.Js=0,null!==this.content&&"string"==typeof this.content&&null!==e&&(this.content=this.Ot(e))}Bs(t){return"string"==typeof t.content&&this.Et()===t.content||"string"!=typeof t.content&&this.content===t.content}Fs(t){return this.t===t.t&&this._s.lt===t._s.lt}Gs(){return"reentryBehavior"in this.component?this.component.Gs:"default"}Ms(t){return("string"==typeof t.content&&this.Et()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}Qs(t){0===this.Ls&&(this.zs||(this.component=this.Ws(t)),this.Ls=1)}Ks(){1===this.Ls&&(this.Ls=0)}Xs(t,s){if(!this.component)return Promise.resolve(0);if(!this.component.Xs)return Promise.resolve(1);const e=i(this.t,this._s.lt,this.content.t);this._s.t=e.i,this._s.o=e.o;const n=this.component.Xs(e.l,this._s,s);return kernel.Reporter.write(1e4,"viewport canEnter",n),"boolean"==typeof n?Promise.resolve(n):"string"==typeof n?Promise.resolve([new l(n,t)]):n}Ys(t){if(!this.component||!this.component.Ys)return Promise.resolve(1);const s=this.component.Ys(this._s,t);return kernel.Reporter.write(1e4,"viewport canLeave",s),"boolean"==typeof s?Promise.resolve(s):s}async Us(t){if(this.Js||1===this.Ls&&!this.Ds){if(this.component.Us){const s=i(this.t,this._s.lt,this.content.t);this._s.t=s.i,this._s.o=s.o,await this.component.Us(s.l,this._s,t)}this.Ds=1}}async Zs(t){4===this.Ls&&this.Ds&&(this.component.Zs&&await this.component.Zs(this._s,t),this.Ds=0)}loadComponent(t,s){if(1===this.Ls&&this.Ds)return this.zs||runtime.Controller.ti(this.component,t,s),this.Ls=2,Promise.resolve()}si(){2===this.Ls&&(this.Ls=1)}ii(){2===this.Ls&&(this.zs||this.component.hi.bind(5120,null),this.Ls=3)}ei(t=0){3===this.Ls&&(t||(this.component.hi.ni(10240),this.Ls=2))}addComponent(t){if(3===this.Ls){if(this.component.hi.ri(1024),this.zs){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.Ls=4}}oi(t,s=0){if(4===this.Ls&&!this.Ds){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.hi.detach(2048),this.Ls=3}}async li(t,s,i=0){switch(this.Ls){case 4:await this.Zs(s),this.oi(t,i);case 3:this.ei(i);case 2:this.si();case 1:this.Ks()}}Et(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}Ot(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(kernel.IContainer),i=s.xt(runtime.CustomElementResource.Tt(this.content));return null!==i?i.jt(s).qt:null}}Ws(t){if(null===this.content)return null;const component=this.Et();return t.get(kernel.IContainer).get("string"!=typeof component?component:runtime.CustomElementResource.Tt(component))}}class S{constructor(router,name,t,s,i,e,n){this.router=router,this.name=name,this.ai=t,this.context=s,this.ci=i,this.scope=e,this.options=n,this.clear=0,this.content=new E,this.ui=null,this.fi=null,this.pi=null,this.cache=[],this.enabled=1}di(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.es.wi)this.clear=1,t=null;else{const s=this.router.es.rs(t);t=s.Et,i=s.Vt}if(this.ui=new E(t,i,s,this.context),this.options.vi){const t=this.cache.find(t=>this.ui.Ms(t));t?(this.ui=t,this.ui.zs=1):this.cache.push(this.ui)}return!this.content.Bs(this.ui)||s.Y||"refresh"===this.content.Gs()?1:"disallow"!==this.content.Gs()?this.content.Fs(this.ui)&&"enter"!==this.content.Gs()?0:(this.content.Js=1,this.ui.content=this.content.content,this.ui.component=this.content.component,this.ui.Ls=this.content.Ls,this.ui.Js=this.content.Js,1):void 0}mi(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.ai&&(this.scope.ai=t),this.ai!==t&&(this.pi={...this},this.gi(),this.ai=t,i&&i.yi&&(this.options.yi=i.yi),i&&i.default&&(this.options.default=i.default),i&&i.$i&&(this.options.$i=i.$i),i&&i.bi&&(this.options.bi=i.bi),i&&i.vi&&(this.options.vi=i.vi),this.fi&&this.fi()),s&&(s.St=this.name),this.context!==s&&(this.context=s),this.content.component||this.ui&&this.ui.component||!this.options.default||this.router.Ci(this.options.default,this)}remove(t,s){return this.ai===t&&this.context===s?(this.content.component&&this.content.li(this.ai,this.ui?this.ui._s:null,this.options.vi).catch(t=>{throw t}),1):0}async Ys(){return this.content.Ys(this.ui._s)}async Xs(){return this.clear?1:this.ui.content?(await this.Pi(),this.ui.Qs(this.context),this.ui.Xs(this,this.content._s)):0}async Us(){return kernel.Reporter.write(1e4,"Viewport enter",this.name),this.clear?1:this.ui&&this.ui.component?(await this.ui.Us(this.content._s),await this.ui.loadComponent(this.context,this.ai),this.ui.ii(),1):0}async Ei(){return kernel.Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&!this.ui.component&&(await this.content.Zs(this.ui._s),this.content.oi(this.ai,this.options.vi),this.content.ei(this.options.vi),this.content.si(),this.content.Ks()),this.ui.component&&(this.ui.addComponent(this.ai),this.content.component&&(await this.content.Zs(this.ui._s),this.content.Js||(this.content.oi(this.ai,this.options.vi),this.content.ei(this.options.vi),this.content.si(),this.content.Ks())),this.content=this.ui,this.content.Js=0),this.clear&&(this.content=new E(null,null,this.ui._s)),this.ui=null,1}Si(){this.pi=null}async Vi(){await this.ui.li(this.ai,this.ui?this.ui._s:null,this.options.vi),this.pi&&Object.assign(this,this.pi)}description(t=0){if(this.content.content){const component=this.content.Et();if(t||this.scope||this.options.ki)return this.router.es.Ri(new l(component,this,this.content.t,null!==this.scope));const s=this.ci.Ii([new l(component)]);return this.router.es.Ri(new l(component,s&&s.Hi&&s.Hi.length?null:this,this.content.t))}}Ai(t=0){const s=[this.ci.Ni(t),this.description(t)];return this.router.es.Oi(s.filter(value=>value&&value.length))}xi(component){let t=this.options.yi||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Ti(component){if("-"===component||null===component)return 1;let t=this.options.yi;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}qi(t){this.content.component&&this.content.ii()}ji(t){kernel.Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.ui),this.enabled=1,this.content.component&&this.content.addComponent(this.ai)}Ui(t){kernel.Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.oi(this.ai,this.options.vi),this.enabled=0}_i(t){this.content.component&&this.content.ei(this.options.vi)}gi(){this.options={},this.content=new E,this.cache=[]}async Pi(){return this.ai?Promise.resolve():new Promise(t=>{this.fi=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.ai=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.Li=[],this.Di=null,this.parent&&this.parent.zi(this)}Ji(){return this.Li.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}Ii(t){const instructions=[];let s=0;t?(this.Di={},this.Hi=t.slice()):this.Hi||(this.Hi=[]),this.Di={...this.Ji(),...this.Di};for(let t=0;this.Hi.length>t;t++){const i=this.Hi[t];for(const name in this.Di){const e=this.Di[name];if(e&&e.xi(i.Et)){const n=this.Bi(i,e);instructions.push(...n.Hi),s=s||n.Fi,this.Di[name]=null,this.Hi.splice(t--,1);break}}}for(let t=0;this.Hi.length>t;t++){const i=this.Hi[t],name=i.St;if(!name||!name.length)continue;const e=i.At;this.Ji()[name]||(this.Gi(name,null,null,{scope:e,ki:1}),this.Di[name]=this.Ji()[name]);const n=this.Di[name];if(n&&n.Ti(i.Et)){const e=this.Bi(i,n);instructions.push(...e.Hi),s=s||e.Fi,this.Di[name]=null,this.Hi.splice(t--,1)}}for(let t=0;this.Hi.length>t;t++){const i=this.Hi[t],e=[];for(const name in this.Di){const t=this.Di[name];t&&t.Ti(i.Et)&&e.push(t)}if(1===e.length){const n=e.shift(),r=this.Bi(i,n);instructions.push(...r.Hi),s=s||r.Fi,this.Di[n.name]=null,this.Hi.splice(t,1);break}}if(s=s||this.Hi.length>0,!t)for(const t of this.children){const i=t.Ii();instructions.push(...i.Hi),s=s||i.Fi}return{Hi:instructions,Fi:s}}Bi(t,s){t.It(s);const instructions=[t];let i=0;if(t.Nt){const e=(s.scope||s.ci).Ii([t.Nt]);instructions.push(...e.Hi),i=i||e.Fi}return{Hi:instructions,Fi:i}}Gi(name,t,s,i){let e=this.Ji()[name];if(t&&e&&null!==e.ai&&e.ai!==t&&(e.enabled=0,(e=this.Li.find(s=>s.name===name&&s.ai===t))&&(e.enabled=1)),!e){let n;i.scope&&(n=new Scope(this.router,t,s,this),this.router.Mi.push(n)),e=new S(this.router,name,null,null,this,n,i),this.Li.push(e)}return(t||s)&&e.mi(t,s,i),e}Qi(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.Wi(t.scope),this.Li.splice(this.Li.indexOf(t),1)),Object.keys(this.Li).length}Wi(){for(const t of this.children)t.Wi();const t=this.Ji();for(const name in t)this.router.Qi(t[name],null,null)}zi(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}Ki(t=0,s=0){const i=[];for(const e in this.Ji()){const n=this.Ji()[e];(n.options.bi||n.options.$i&&!t)&&!s||i.push(n.Ai(t))}for(const s of this.children)i.push(...s.Ki(t));return i.filter(value=>value&&value.length)}_t(){const t=this.Li.filter(t=>t.enabled);for(const s of this.children)t.push(...s._t());return t}Ni(t=0){if(!this.ai||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.Xi(this.context.get(kernel.IContainer).parent);for(;i&&i.ci===this.parent;)s.unshift(i.description(t)),i=this.Xi(i.context.get(kernel.IContainer).parent);return s.unshift(this.parent.Ni(t)),this.router.es.Oi(s.filter(value=>value&&value.length))}Xi(t){const s=Object.values(this.Ji());for(;t;){const i=s.find(s=>s.context.get(kernel.IContainer)===t);if(i)return i;t=t.parent}return null}}const V=kernel.DI.Zi("IRouteTransformer").Yi(t=>t.singleton(b)),k=kernel.DI.Zi("IRouter").Yi(t=>t.singleton(R));class R{constructor(t,s,i,e,n){this.Mi=[],this.th={},this.ns=[],this.sh=[],this.g=0,this.ih=[],this.hh=null,this.eh=null,this.nh=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.rh(t.anchor).Ni();s=this.es.oh(i,s)}this.lh.wt(s)}),this.Wt=t,this.ah=s,this.lh=i,this.uh=e,this.es=n}get fh(){return null!==this.hh}V(t){if(this.g)throw kernel.Reporter.error(2001);return this.g=1,this.options={C:t=>{this.ph(t)},Is:this.ah.Is,Hs:this.ah.Hs,...t},this.es.V({dh:this.options.dh}),this.uh.V({C:this.nh}),this.lh.V(this.options).catch(t=>{throw t})}I(){if(!this.g)throw kernel.Reporter.error(2e3);this.uh.I(),this.lh.I()}ph(t){this.ih.push(t),this.wh().catch(t=>{throw t})}async wh(){if(null!==this.hh||!this.ih.length)return Promise.resolve();const t=this.ih.shift();this.hh=t,this.options.vh&&this.options.vh(t);let i=0;(t.nt||t.et)&&t.ot&&(t.path=t.ot,i=1);let e=t.path;if(this.options.Is&&!i){const t=this.options.Is(e,this);e=Array.isArray(t)?this.es.ls(t):t}const{mh:n,gh:r}=this.es.yh(e);n&&(e=r);const o=s(t.lt);t.t=o.t,t.o=o.list;const l=this.es.hs(e);if(!l&&!l.length&&!n)return this.hh=null,this.wh();const a=n?this._t().filter(value=>null!==value.content.component):[],c=this._t().filter(value=>value.options.default&&null===value.content.component),u=[];let{Hi:f,Fi:p}=this.$h.Ii(l),d=100;for(;f.length||p||c.length;){if(!d--)throw kernel.Reporter.error(2002);const s=[];for(const i of f){const e=i.viewport,n=this.es.Ri(i,1);e.di(n,t)&&s.push(e);const r=a.findIndex(value=>value===e);0>r||a.splice(r,1);const o=c.findIndex(value=>value===e);0>o||c.splice(o,1)}for(const i of a)i.di(this.es.wi,t)&&s.push(i);let i;for(;i=c.shift();)i.di(i.options.default,t)&&s.push(i);let e=await Promise.all(s.map(value=>value.Ys()));if(e.findIndex(value=>0==value)>=0)return this.bh([...s,...u],t);if((e=await Promise.all(s.map(async value=>{const t=await value.Xs();if("boolean"==typeof t)return t?value.Us():0;for(const s of t)this.Ci(s);return value.Vi().catch(t=>{throw t}),1}))).some(t=>0==t))return this.bh([...s,...u],t);for(const t of s)u.find(value=>value===t)||u.push(t);const n=this.$h.Ii();let r;for(f=[];r=this.sh.shift();)n.Hi.find(value=>value.viewport===r.viewport)||f.push(r);f=[...f,...n.Hi],p=n.Fi}await Promise.all(u.map(value=>value.Ei())),await this.Ch(t),t.rt||t.Ph||!u.every(t=>t.options.bi)||await this.lh.pop(),u.forEach(t=>{t.Si()}),this.eh=this.hh,this.eh.Ph&&(this.eh.Ph=0),this.hh=null,this.wh().catch(t=>{throw t})}Ci(t,s){this.hh?t instanceof l?(t.viewport||(t.viewport=this._t().find(s=>s.name===t.St)),this.sh.push(t)):("string"==typeof s&&(s=this._t().find(t=>t.name===s)),this.sh.push(new l(t,s))):this.eh&&(this.ih.unshift({path:"",ot:"",Ph:1}),this.wh().catch(t=>{throw t}))}Eh(t){return this.Sh(),this.rh(t)}Vh(name){return this._t().find(t=>t.name===name)}Gi(name,t,s,i){return kernel.Reporter.write(1e4,"Viewport added",name,t),this.Eh(t).Gi(name,t,s,i)}Qi(t,s,i){const e=t.ci;e.Qi(t,s,i)||this.Wi(e)}_t(){return this.Sh(),this.$h._t()}Wi(t){if(t!==this.$h){t.Wi();const s=this.Mi.indexOf(t);0>s||this.Mi.splice(s,1)}}ft(t,s,i){if("string"==typeof t)return this.lh.ft(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.lh.replace(t,s,i)}refresh(){return this.lh.refresh()}back(){return this.lh.back()}forward(){return this.lh.forward()}kh(name,t){const s=this.Rh(name);s&&(s.as=[]),this.Ih(name,t)}Ih(name,t){let s=this.th[name];s||(s=this.th[name]=new c(this,name)),s.cs(t),this.th[name]=new c(s.router,s.name,s.as)}Rh(name){return this.th[name]}async bh(t,s){t.forEach(t=>{t.Vi().catch(t=>{throw t})}),s.F?await this.lh.pop():await this.lh.cancel(),this.hh=null,this.wh().catch(t=>{throw t})}Sh(){if(!this.$h){const t=this.Wt.get(runtime.Aurelia).root;this.$h=new Scope(this,t.host,t.controller.context,null),this.Mi.push(this.$h)}}rh(t){let s=t;for(;s.parentElement;){const t=this._t().find(t=>t.ai===s);if(t&&t.ci)return t.ci;s=s.parentElement}return this.$h}Ch(t){this.ns=this.$h.Ki(1,1),this.ns=this.es.Hh(this.ns);let s=this.$h.Ki();s=this.es.Hh(s);let i=this.es.Ah(s);if(this.options.Hs){const t=this.options.Hs(this.es.hs(i),this);i=Array.isArray(t)?this.es.ls(t):t}let e=this.$h.Ki(1);e=this.es.Hh(e);const n=t.lt&&t.lt.length?`?${t.lt}`:"";return this.lh.dt(i+n,this.es.Ah(e,1)+n,t)}}R.inject=[kernel.IContainer,V,r,o,class{V(t){this.dh={viewport:"@",Nh:"+",scope:"/",At:"!",t:"(",Oh:")",xh:"&",add:"+",clear:"-",action:".",...t.dh}}get wi(){return this.dh.clear}hs(instructions){return null===instructions||""===instructions?[]:(instructions.startsWith("/")&&(instructions=instructions.slice(1)),instructions.split(this.dh.Nh).map(t=>this.rs(t)))}rs(t){const instructions=t.split(this.dh.scope).map(t=>this.Th(t));for(let t=0;instructions.length-1>t;t++)instructions[t].Nt=instructions[t+1];return instructions[0]}ls(instructions){return instructions.map(t=>this.Ri(t)).join(this.dh.Nh)}Ri(t,s=0){if("string"==typeof t)return this.qh(t,s);{const instructions=[t];for(;t=t.Nt;)instructions.push(t);return instructions.map(t=>this.qh(t,s)).join(this.dh.scope)}}jh(t){return t.split(this.dh.scope).map(t=>this.rs(t))}Oi(instructions){return Array.isArray(instructions)?instructions.map(t=>this.Ri(t)).join(this.dh.scope):this.Oi([instructions])}oh(t,s){return t&&(s=`/${t}${this.dh.scope}${s}`),s}yh(t){return{mh:t===this.dh.clear||t.startsWith(this.dh.clear+this.dh.add),gh:t.startsWith(this.dh.clear)?t.slice(2):t}}Hh(t){let s=t.slice().sort((t,s)=>s.split(this.dh.scope).length-t.split(this.dh.scope).length),i=[];if((s=s.map(value=>`${this.dh.scope}${value}${this.dh.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.dh.scope).length-s.split(this.dh.scope).length),i}Ah(t,s=0){const i=t.slice();return s&&i.unshift(this.wi),i.join(this.dh.Nh)}Th(t){let component,s,i,e;const[n,r]=t.split(this.dh.viewport);void 0===r?([component,...i]=n.split(this.dh.t),component.endsWith(this.dh.At)&&(e=1,component=component.slice(0,-this.dh.At.length))):(component=n,[s,...i]=r.split(this.dh.t),s.endsWith(this.dh.At)&&(e=1,s=s.slice(0,-this.dh.At.length)));let o=i.length?i.join(this.dh.t):void 0;return this.dh.Oh.length&&o&&o.endsWith(this.dh.Oh)&&(o=o.slice(0,-this.dh.Oh.length)),new l(component,s,o,e)}qh(t,s=0){if("string"==typeof t)return this.Ri(this.rs(t),s);{let i=t.Et;return null==t.St||s||(i+=this.dh.viewport+t.St),t.Vt&&(i+=this.dh.t+t.Vt+this.dh.Oh),i}}}],t.Uh=class{constructor(router){this.router=router,this.name=null,this.as=null,this.level=0}get _h(){const t=this.router.th[this.name];return t?t.as:[]}active(t){return"Active"}},e([runtime.bindable],t.Uh.prototype,"name",void 0),e([runtime.bindable],t.Uh.prototype,"routes",void 0),e([runtime.bindable],t.Uh.prototype,"level",void 0),t.Uh=e([kernel.inject(R,runtime.INode),runtime.customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],t.Uh);class I{constructor(router,t,s){this.name="default",this.scope=null,this.yi=null,this.default=null,this.$i=null,this.bi=null,this.vi=null,this.viewport=null,this.router=router,this.ai=t,this.Lh=s}Dh(t,host,parts,s){const i=this.constructor,dom=s.get(runtime.IDOM),template=this.Lh.zh(dom,i.description,s,i);template.Jh=runtime.createRenderContext(dom,s,i.description.dependencies,i),template.Dh(this,host,parts)}bound(){this.connect()}Bh(){this.disconnect()}connect(){const t={scope:this.ai.hasAttribute("scope")};this.yi&&this.yi.length&&(t.yi=this.yi),this.default&&this.default.length&&(t.default=this.default),this.ai.hasAttribute("no-link")&&(t.$i=1),this.ai.hasAttribute("no-history")&&(t.bi=1),this.ai.hasAttribute("stateful")&&(t.vi=1),this.viewport=this.router.Gi(this.name,this.ai,this.hi.context,t)}disconnect(){this.router.Qi(this.viewport,this.ai,this.hi.context)}qi(t){this.viewport&&this.viewport.qi(t)}ji(t){this.viewport&&this.viewport.ji(t)}Ui(t){this.viewport&&this.viewport.Ui(t)}_i(t){this.viewport&&this.viewport._i(t)}}I.inject=[R,runtime.INode,runtime.IRenderingEngine],e([runtime.bindable],I.prototype,"name",void 0),e([runtime.bindable],I.prototype,"scope",void 0),e([runtime.bindable],I.prototype,"usedBy",void 0),e([runtime.bindable],I.prototype,"default",void 0),e([runtime.bindable],I.prototype,"noLink",void 0),e([runtime.bindable],I.prototype,"noHistory",void 0),e([runtime.bindable],I.prototype,"stateful",void 0),runtime.CustomElementResource.Fh({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> ${scope ? "[new scope]" : ""} : <b>${viewport.content && viewport.content.componentName()}</b></div></template>'},I);const H=R,DefaultComponents=[H],A=I,N=t.Uh,DefaultResources=[I,t.Uh],O={register:t=>t.register(...DefaultComponents,...DefaultResources),Gh(){return this.register(kernel.DI.Gh())}};t.Mh=w,t.DefaultComponents=DefaultComponents,t.DefaultResources=DefaultResources,t.Qh=g,t.Wh=$,t.Kh=u,t.Xh=r,t.Yh=V,t.Zh=k,t.te=o,t.se=c,t.ie=N,t.he=n,t.ee=d,t.ne=f,t.re=class{constructor(){this.oe=new State,this.names={},this.as=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.oe;const i=[];let e="^";const n=new p,r=[],o=t.yt.name;let l=1,a=t.path;"/"===a.charAt(0)&&(a=a.slice(1));const c=[],d=a.split("/");let v,b;for(let o=0,a=d.length;a>o;++o){let a=(v=d[o]).match(/^:([^?]+)(\?)?$/);if(a){const[,name,optional]=a;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);c.push(b=new g(name,!!optional)),r.push(name),n.ws++}else if(a=v.match(/^\*(.+)$/))c.push(b=new y(a[1])),r.push(a[1]),n.vs++;else{if(""===v){c.push(new $);continue}c.push(b=new m(v,t.Ss)),n.ds++}const u=s.put(new w(null,"/",0));let f=u;b.Vs(t=>{f=f.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].Ps.push(u);b.optional?(i.push(f),e+=`(?:/${b.ks()})?`):(s=f,e+=`/${b.ks()}`,i.length=0,l=0)}l&&(s=s.put(new w(null,"/",0)),e+="/?");const C=[new u(t.yt,r)];if(this.as.set(t.yt,new f(c,C)),o){const t=Array.isArray(o)?o:[o];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new f(c,C))}for(let s=0;i.length>s;s++){const r=i[s];r.ps=C,r.ks=RegExp(`${e}$`,t.Ss?"":"i"),r.types=n}return s.ps=C,s.ks=RegExp(`${e}$`,t.Ss?"":"i"),s.types=n,s}le(t){return"string"==typeof t?this.names[t]:this.as.get(t)}ae(t){const s=this.le(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.ps]}ce(t){return!!this.le(t)}Rs(t,s){const i=this.le(t);if(!i)throw Error(`There is no route named ${t}`);const e=i.ps[0].yt;if(e.ue)return e.href;const n={...s},r=i.fs,o={};let l="";for(let s=0,i=r.length;i>s;s++){const i=r[s];if(i instanceof $)continue;const e=i.Rs(n,o);if(null==e){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else l+="/",l+=e}"/"!==l.charAt(0)&&(l=`/${l}`);for(const t in o)Reflect.deleteProperty(n,t);const a=kernel.buildQueryString(n);return l+(a?`?${a}`:"")}fe(t){let s=[this.oe],i={},e=0,n=t;const r=n.indexOf("?");if(-1!==r){const t=n.slice(r+1);n=n.slice(0,r),i=kernel.parseQueryString(t)}"/"!==(n=decodeURI(n)).charAt(0)&&(n=`/${n}`);let o=n.length;o>1&&"/"===n.charAt(o-1)&&(n=n.slice(0,-1),e=1,--o);for(let t=0;o>t;++t){const i=[],e=n.charAt(t);if(s.forEach(t=>{t.Ps.forEach(t=>{null!==t.Cs.$s?-1!==t.Cs.$s.indexOf(e)&&i.push(t):null!==t.Cs.ys&&-1===t.Cs.ys.indexOf(e)&&i.push(t)})}),0===(s=i).length)break}const l=[];for(let t=0,i=s.length;i>t;t++)s[t].ps&&l.push(s[t]);l.sort((t,s)=>{if(t.types.vs!==s.types.vs)return t.types.vs-s.types.vs;if(t.types.vs){if(t.types.ds!==s.types.ds)return s.types.ds-t.types.ds;if(t.types.ws!==s.types.ws)return s.types.ws-t.types.ws}return t.types.ws!==s.types.ws?t.types.ws-s.types.ws:t.types.ds!==s.types.ds?s.types.ds-t.types.ds:0});const a=l[0];if(a&&a.ps){e&&"(.+)$"===a.ks.source.slice(-5)&&(n=`${n}/`);const t=n.match(a.ks);let s=1;const r=[];return r.pe=i,a.ps.forEach(i=>{const e={};i.names.forEach(name=>{e[name]=t[s++]}),r.push(new d(i.yt,e,i.names.length>0))}),r}}},t.de=R,t.we=O,t.ve=H,t.Scope=Scope,t.me=y,t.State=State,t.ge=m,t.ye=p,t.$e=S,t.be=E,t.Ce=I,t.Pe=A,t.Ee=l,Object.defineProperty(t,"Se",{value:1})});
