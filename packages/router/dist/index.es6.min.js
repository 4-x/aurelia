function parseQuery(t){const s={},i=[];if(!t||!t.length)return{t:s,list:i};const e=t.replace("+"," ").split("&");for(const t of e){const e=t.split("="),n=decodeURIComponent(e.shift());if(!e.length){i.push(n);continue}const value=decodeURIComponent(e.shift());s[n]=value}return{t:s,list:i}}function mergeParameters(t,s,i){const e=parseQuery(s),n=parseQuery(t),r={...e.t,...n.t},o=[...e.list,...n.list];if(o.length&&i&&i.length)for(const t of i)r[t]=o.shift();let a;return o.length&&Object.keys(r).length&&(r["s"]=o.splice(0,o.length)),{i:r,o,l:a=o.length?o:r}}function __decorate(t,s,i,e){var n,r,o=arguments.length,a=3>o?s:null===e?e=Object.getOwnPropertyDescriptor(s,i):e;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,s,i,e);else for(r=t.length-1;r>=0;r--)(n=t[r])&&(a=(3>o?n(a):o>3?n(s,i,a):n(s,i))||a);return o>3&&a&&Object.defineProperty(s,i,a),a}var ContentStatus,ReentryBehavior;import{Reporter,IContainer,buildQueryString,parseQueryString,DI,inject}from"@aurelia/kernel";import{ILifecycle,CustomElementResource,IObserverLocator,Controller,Aurelia,bindable,INode,customElement,IDOM,createRenderContext,IRenderingEngine}from"@aurelia/runtime";import{DOM}from"@aurelia/runtime-html";class QueuedBrowserHistory{constructor(t){this.u=(async t=>this.p(this,"popstate",[t])),this.m=t,this.g=[],this.v=0,this.C=null,this.R=null,this.S=null,this.I=null}V(t){if(this.v)throw Reporter.error(2003);this.v=1,this.R=t,this.m.$(this.H,this,4096),DOM.window.addEventListener("popstate",this.u)}N(){DOM.window.removeEventListener("popstate",this.u),this.m.P(this.H,this),this.R=null,this.v=0}get length(){return DOM.window.history.length}get state(){return DOM.window.history.state}get D(){return DOM.window.history.D}async go(t,s=0){if(!s)return this.p(this,"_go",[t],1);const i=this.p(this,"suppressPopstate",[],1);return this.p(DOM.window.history,"go",[t]).catch(t=>{throw t}),i}back(){return this.go(-1)}forward(){return this.go(1)}async pushState(t,s,i){return this.p(DOM.window.history,"pushState",[t,s,i])}async replaceState(t,s,i){return this.p(DOM.window.history,"replaceState",[t,s,i])}async O(t){if(this.I){const t=this.I;this.I=null,t()}else{if(this.S){const t=this.S;this.S=null,t(),await Promise.resolve()}this.R(t)}}k(t,s){this.S=s,DOM.window.history.go(t)}A(t){this.I=t}p(t,s,i,e=0){let n;const r=new Promise(t=>{n=t});return e&&(i.push(n),n=null),this.g.push({target:t,T:s,t:i,resolve:n}),r}async H(t){if(!this.g.length||null!==this.C)return;this.C=this.g.shift();const s=this.C.target[this.C.T];Reporter.write(1e4,"DEQUEUE",this.C.T,this.C.t),s.apply(this.C.target,this.C.t);const i=this.C.resolve;this.C=null,i&&i()}}QueuedBrowserHistory.inject=[ILifecycle];class HistoryBrowser{constructor(t){this.L=(async()=>{const t=this.M(),s=this.B();Reporter.write(1e4,"path changed to",t,this.j,this.q);const i={};let e,n=this.U("HistoryEntry");if(this.j&&this.j.path===t){i.G=1;const t=this.J?this.q.index:this.history.length-this.F;e=this.q,this.q=this.j,this.q.index=t,this.J?(this.W=0,this.K[this.q.index]=this.q,this.X?(i.Y=1,this.X=0):i.Z=1,this.J=0):(this.W=1,this.K=this.K.slice(0,this.q.index),this.K.push(this.q)),await this.tt({st:this.K,it:this.F,et:this.q})}else this.K=this.K||this.U("HistoryEntries")||[],this.F=this.F||this.U("HistoryOffset")||0,n||this.q?n?this.q?n.index>this.q.index?i.nt=1:this.q.index>n.index&&(i.rt=1):i.Y=1:i.G=1:(i.G=1,i.ht=1,this.F=this.history.length),n||(n={path:t,ot:null,index:this.history.length-this.F,at:s},i.ht&&(n.lt=1),this.K=this.K.slice(0,n.index),this.K.push(n),await this.tt({st:this.K,it:this.F,et:n})),this.W=this.q?n.index-this.q.index:0,e=this.q,this.q=n;this.j=null,Reporter.write(1e4,"navigated",this.U("HistoryEntry"),this.K,this.U("HistoryOffset")),this.R(this.q,i,e)}),this.history=new QueuedBrowserHistory(t),this.q=null,this.K=null,this.F=null,this.ut=null,this.j=null,this.options=null,this.v=0,this.W=null,this.J=0,this.X=0}V(t){if(this.v)throw Reporter.error(0);return this.v=1,this.options={...t},this.history.V(this.L),Promise.resolve().then(()=>{this.ct(this.M(),1).catch(t=>{throw t})})}N(){this.history.N(),this.v=0}pt(t,s,i){return this.j={path:t,ot:null,title:s,data:i},this.ct(t)}replace(t,s,i){return this.J=1,this.j={path:t,ot:null,title:s,data:i},this.ct(t,1)}async refresh(){if(this.q)return this.X=1,this.replace(this.q.path,this.q.title,this.q.data)}back(){return this.history.go(-1)}forward(){return this.history.go(1)}cancel(){const t=this.W;return t?(this.W=0,this.history.go(-t,1)):this.replace(this.ut.path,this.ut.title,this.ut.data)}async pop(){await this.history.go(-1,1);const t=""+this.location,s=this.history.state;if(!s.et.lt)return await this.history.go(-1,1),this.history.pushState(s,null,t)}async tt(t,value){const{pathname:s,search:i,hash:e}=this.location;let n={...this.history.state};return"string"==typeof t?n[t]=JSON.parse(JSON.stringify(value)):n={...n,...JSON.parse(JSON.stringify(t))},this.history.replaceState(n,null,`${s}${i}${e}`)}U(t){return{...this.history.state}[t]}ft(t){return this.q.title=t,this.K[this.q.index]=this.q,this.tt({st:this.K,et:this.q})}wt(t,s,i){if(i.index!==this.q.index)return;const e=`#${t}`,{pathname:n,search:r,hash:o}=this.location;if(e===o&&this.q.path===t&&this.q.ot===s)return;this.q.path=t,this.q.ot=s;const a={...this.history.state,et:this.q,st:this.K};return this.history.replaceState(a,null,`${n}${r}${e}`)}dt(t){t.startsWith("#")||(t=`#${t}`),this.location.hash=t}get gt(){return this.K?this.K.slice(0,this.q.index+1).map(value=>value.title):[]}M(){return this.location.hash.substring(1).split("?")[0]}async ct(t,s=0){const{pathname:i,search:e}=this.location,n=`#${t}`;return s?(this.ut=this.q,await this.history.replaceState({},null,`${i}${e}${n}`)):await this.history.pushState({},null,`${i}${e}${n}`),this.L()}B(){const t=this.location.hash.substring(1).split("?");return t.shift(),t.length>0?t.shift():""}R(t,s,i){const e={...t,...s};e.vt=i,Reporter.write(1e4,"callback",t,s),this.options.R&&this.options.R(e)}}HistoryBrowser.inject=[ILifecycle];class LinkHandler{constructor(){this.v=0,this.yt=(t=>{const s=LinkHandler.Ct(t);s.Rt&&(t.preventDefault(),this.options.R(s))})}static Ct(t){const s={Rt:0,href:null,anchor:null},i=LinkHandler.Et(t.target);if(!i||!LinkHandler.bt(i))return s;if(i.hasAttribute("external"))return s;if(t.altKey||t.ctrlKey||t.metaKey||t.shiftKey)return s;const e=i.getAttribute("href");return s.anchor=i,s.href=e,s.Rt=1===t.which,s}static Et(t){for(;t;){if("A"===t.tagName)return t;t=t.parentNode}}static bt(t){const s=t.getAttribute("target");return!s||s===DOM.window.name||"_self"===s}V(t){if(this.v)throw Reporter.error(2004);this.v=1,this.options={...t},DOM.document.addEventListener("click",this.yt,1)}N(){DOM.document.removeEventListener("click",this.yt,1),this.v=0}}class ViewportInstruction{constructor(component,t,s,i=0,e=null){this.component=null,this.St=null,this.viewport=null,this.It=null,this.Vt=null,this.t=null,this.$t=null,this.Ht(component),this.Nt(t),this.Pt(s),this.Dt=i,this.Ot=e}Ht(component){"string"==typeof component?(this.St=component,this.component=null):(this.component=component,this.St=component.description.name)}Nt(t){void 0!==t&&""!==t||(t=null),"string"==typeof t?(this.It=t,this.viewport=null):(this.viewport=t,null!==t&&(this.It=t.name))}Pt(t){void 0!==t&&""!==t||(t=null),"string"==typeof t?(this.Vt=t,this.t={id:t}):this.t=t}kt(t){if(null!==this.component)return this.component;const s=t.get(IContainer),i=s._t(CustomElementResource.At(this.St));return null!==i?i.Lt(s).Tt:null}xt(router){return null!==this.viewport?this.viewport:router.Mt()[this.It]}Bt(t,s=0,i=0){return s&&this.Vt!==t.Vt?0:i?this.component===t.component:this.St===t.St}}class NavRoute{constructor(t,s){this.active="",this.Qt=t,Object.assign(this,{title:s.title,children:null,jt:s.jt,active:""}),this.instructions=this.zt(s.qt),this.link=this.Ut(this.instructions),this.Gt=s.Jt?this.Ut(this.zt(s.Jt)):this.link,this.Ft=this.Qt.router.Wt.get(IObserverLocator),this.Kt=this.Ft.Xt(0,this.Qt.router,"activeComponents"),this.Kt.subscribe(this)}get Yt(){return this.children&&this.children.length?"nav-has-children":""}Zt(){this.active=this.link&&this.link.length?this.ts():"nav-active"===this.active?"nav-active":this.ss()?"nav-active-child":""}ts(){const t=this.Qt.router.ns.es(this.Gt),s=this.Qt.router.rs.map(t=>this.Qt.router.ns.hs(t));for(const component of t)if(!s.find(t=>t.Bt(component)))return"";return"nav-active"}os(){this.active=this.active.startsWith("nav-active")?"":"nav-active"}Ut(instructions){return this.Qt.router.ns.as(instructions)}zt(t){if(!Array.isArray(t))return this.zt([t]);const instructions=[];for(const s of t)instructions.push("string"==typeof s?this.Qt.router.ns.hs(s):s instanceof ViewportInstruction?s:s.component?new ViewportInstruction(s.component,s.viewport,s.t):new ViewportInstruction(s));return instructions}ss(){if(this.children)for(const t of this.children)if(t.active.startsWith("nav-active")||t.ss())return 1;return 0}}class Nav{constructor(router,name,t=[]){this.router=router,this.name=name,this.ls=t}us(t){for(const s of t)this.cs(this.ls,s)}cs(t,s){const i=new NavRoute(this,s);if(t.push(i),s.children){i.children=[];for(const t of s.children)this.cs(i.children,t)}}}class HandlerEntry{constructor(t,s){this.yt=t,this.names=s}}class RouteGenerator{constructor(t,s){this.ps=t,this.fs=s}}class TypesRecord{constructor(){this.ms=0,this.ws=0,this.ds=0}}class RecognizeResult{constructor(t,s,i){this.yt=t,this.gs=s,this.vs=i}}class CharSpec{constructor(t,s,i){this.ys=t,this.Cs=s,this.repeat=i}Rs(t){return this.Cs===t.Cs&&this.ys===t.ys}}class State{constructor(t){this.Es=t,this.bs=[]}put(t){let s=this.bs.find(s=>s.Es.Rs(t));return void 0===s&&(s=new State(t),this.bs.push(s),t.repeat&&s.bs.push(s)),s}}const specials=["/",".","*","+","?","|","(",")","[","]","{","}","\\"],escapeRegex=RegExp(`(\\${specials.join("|\\")})`,"g");class StaticSegment{constructor(t,s){this.name=t,this.Ss=t,this.Is=s,this.optional=0}Vs(t){const s=this.Ss,i=s.length;let e=0,n="";if(this.Is)for(;i>e;++e)n=s.charAt(e),t(new CharSpec(null,n,0));else for(;i>e;++e)n=s.charAt(e),t(new CharSpec(null,n.toUpperCase()+n.toLowerCase(),0))}$s(){return this.Ss.replace(escapeRegex,"\\$1")}Hs(t,s){return this.Ss}}class DynamicSegment{constructor(name,optional){this.name=name,this.optional=optional}Vs(t){t(new CharSpec("/",null,1))}$s(){return"([^/]+)"}Hs(t,s){return s[this.name]=1,t[this.name]}}class StarSegment{constructor(name){this.name=name,this.optional=0}Vs(t){t(new CharSpec("",null,1))}$s(){return"(.+)"}Hs(t,s){return s[this.name]=1,t[this.name]}}class EpsilonSegment{Vs(t){}$s(){return""}Hs(t,s){return""}}class RouteRecognizer{constructor(){this.Ns=new State,this.names={},this.ls=new Map}add(t){if(Array.isArray(t))return void t.forEach(t=>{this.add(t)});let s=this.Ns;const i=[];let e="^";const n=new TypesRecord,r=[],o=t.yt.name;let a=1,l=t.path;"/"===l.charAt(0)&&(l=l.slice(1));const u=[],c=l.split("/");let p,f;for(let o=0,l=c.length;l>o;++o){let l=(p=c[o]).match(/^:([^?]+)(\?)?$/);if(l){const[,name,optional]=l;if(-1!==name.indexOf("="))throw Error(`Parameter ${name} in route ${t} has a default value, which is not supported.`);u.push(f=new DynamicSegment(name,!!optional)),r.push(name),n.ws++}else if(l=p.match(/^\*(.+)$/))u.push(f=new StarSegment(l[1])),r.push(l[1]),n.ds++;else{if(""===p){u.push(new EpsilonSegment);continue}u.push(f=new StaticSegment(p,t.Is)),n.ms++}const m=s.put(new CharSpec(null,"/",0));let w=m;f.Vs(t=>{w=w.put(t)});for(let t=0,s=i.length;s>t;t++)i[t].bs.push(m);f.optional?(i.push(w),e+=`(?:/${f.$s()})?`):(s=w,e+=`/${f.$s()}`,i.length=0,a=0)}a&&(s=s.put(new CharSpec(null,"/",0)),e+="/?");const m=[new HandlerEntry(t.yt,r)];if(this.ls.set(t.yt,new RouteGenerator(u,m)),o){const t=Array.isArray(o)?o:[o];for(let s=0;t.length>s;s++)t[s]in this.names||(this.names[t[s]]=new RouteGenerator(u,m))}for(let s=0;i.length>s;s++){const r=i[s];r.fs=m,r.$s=RegExp(`${e}$`,t.Is?"":"i"),r.types=n}return s.fs=m,s.$s=RegExp(`${e}$`,t.Is?"":"i"),s.types=n,s}Ps(t){return"string"==typeof t?this.names[t]:this.ls.get(t)}Ds(t){const s=this.Ps(t);if(!s)throw Error(`There is no route named ${t}`);return[...s.fs]}Os(t){return!!this.Ps(t)}Hs(t,s){const i=this.Ps(t);if(!i)throw Error(`There is no route named ${t}`);const e=i.fs[0].yt;if(e.ks)return e.href;const n={...s},r=i.ps,o={};let a="";for(let s=0,i=r.length;i>s;s++){const i=r[s];if(i instanceof EpsilonSegment)continue;const e=i.Hs(n,o);if(null==e){if(!i.optional)throw Error(`A value is required for route parameter '${i.name}' in route '${t}'.`)}else a+="/",a+=e}"/"!==a.charAt(0)&&(a=`/${a}`);for(const t in o)Reflect.deleteProperty(n,t);const l=buildQueryString(n);return a+(l?`?${l}`:"")}_s(t){let s=[this.Ns],i={},e=0,n=t;const r=n.indexOf("?");if(-1!==r){const t=n.slice(r+1);n=n.slice(0,r),i=parseQueryString(t)}"/"!==(n=decodeURI(n)).charAt(0)&&(n=`/${n}`);let o=n.length;o>1&&"/"===n.charAt(o-1)&&(n=n.slice(0,-1),e=1,--o);for(let t=0;o>t;++t){const i=[],e=n.charAt(t);if(s.forEach(t=>{t.bs.forEach(t=>{null!==t.Es.Cs?-1!==t.Es.Cs.indexOf(e)&&i.push(t):null!==t.Es.ys&&-1===t.Es.ys.indexOf(e)&&i.push(t)})}),0===(s=i).length)break}const a=[];for(let t=0,i=s.length;i>t;t++)s[t].fs&&a.push(s[t]);a.sort((t,s)=>{if(t.types.ds!==s.types.ds)return t.types.ds-s.types.ds;if(t.types.ds){if(t.types.ms!==s.types.ms)return s.types.ms-t.types.ms;if(t.types.ws!==s.types.ws)return s.types.ws-t.types.ws}return t.types.ws!==s.types.ws?t.types.ws-s.types.ws:t.types.ms!==s.types.ms?s.types.ms-t.types.ms:0});const l=a[0];if(l&&l.fs){e&&"(.+)$"===l.$s.source.slice(-5)&&(n=`${n}/`);const t=n.match(l.$s);let s=1;const r=[];return r.As=i,l.fs.forEach(i=>{const e={};i.names.forEach(name=>{e[name]=t[s++]}),r.push(new RecognizeResult(i.yt,e,i.names.length>0))}),r}}}class InstructionResolver{V(t){this.Ts={viewport:"@",Ls:"+",scope:"/",Dt:"!",t:"(",xs:")",Ms:"&",add:"+",clear:"-",action:".",...t.Ts}}get Bs(){return this.Ts.clear}es(instructions){return null===instructions||""===instructions?[]:(instructions.startsWith("/")&&(instructions=instructions.slice(1)),instructions.split(this.Ts.Ls).map(t=>this.hs(t)))}hs(t){const instructions=t.split(this.Ts.scope).map(t=>this.Qs(t));for(let t=0;instructions.length-1>t;t++)instructions[t].Ot=instructions[t+1];return instructions[0]}as(instructions){return instructions.map(t=>this.js(t)).join(this.Ts.Ls)}js(t,s=0){if("string"==typeof t)return this.zs(t,s);{const instructions=[t];for(;t=t.Ot;)instructions.push(t);return instructions.map(t=>this.zs(t,s)).join(this.Ts.scope)}}qs(t){return t.split(this.Ts.scope).map(t=>this.hs(t))}Us(instructions){return Array.isArray(instructions)?instructions.map(t=>this.js(t)).join(this.Ts.scope):this.Us([instructions])}Gs(t,s){return t&&(s=`/${t}${this.Ts.scope}${s}`),s}Js(t){return{Fs:t===this.Ts.clear||t.startsWith(this.Ts.clear+this.Ts.add),Ws:t.startsWith(this.Ts.clear)?t.slice(2):t}}Ks(t){let s=t.slice().sort((t,s)=>s.split(this.Ts.scope).length-t.split(this.Ts.scope).length),i=[];if((s=s.map(value=>`${this.Ts.scope}${value}${this.Ts.scope}`)).length)for(i.push(s.shift());s.length;){const t=s.shift();i.find(value=>-1===value.indexOf(t))&&i.push(t)}return(i=i.map(value=>value.substring(1,value.length-1))).sort((t,s)=>t.split(this.Ts.scope).length-s.split(this.Ts.scope).length),i}Xs(t,s=0){const i=t.slice();return s&&i.unshift(this.Bs),i.join(this.Ts.Ls)}Qs(t){let component,s,i,e;const[n,r]=t.split(this.Ts.viewport);void 0===r?([component,...i]=n.split(this.Ts.t),component.endsWith(this.Ts.Dt)&&(e=1,component=component.slice(0,-this.Ts.Dt.length))):(component=n,[s,...i]=r.split(this.Ts.t),s.endsWith(this.Ts.Dt)&&(e=1,s=s.slice(0,-this.Ts.Dt.length)));let o=i.length?i.join(this.Ts.t):void 0;return this.Ts.xs.length&&o&&o.endsWith(this.Ts.xs)&&(o=o.slice(0,-this.Ts.xs.length)),new ViewportInstruction(component,s,o,e)}zs(t,s=0){if("string"==typeof t)return this.js(this.hs(t),s);{let i=t.St;return null==t.It||s||(i+=this.Ts.viewport+t.It),t.Vt&&(i+=this.Ts.t+t.Vt+this.Ts.xs),i}}}class RouteTable{constructor(){this.Ys=(t=>t),this.Zs=(instructions=>instructions)}}(function(t){t[t.ti=0]="none",t[t.si=1]="created",t[t.loaded=2]="loaded",t[t.ii=3]="initialized",t[t.ei=4]="added"})(ContentStatus||(ContentStatus={})),(function(t){t.default="default",t.ni="disallow",t.ri="enter",t.refresh="refresh"})(ReentryBehavior||(ReentryBehavior={}));class ViewportContent{constructor(t=null,s=null,i=null,e=null){this.content=t,this.t=s,this.hi=i,this.component=null,this.oi=0,this.ai=0,this.li=0,this.ui=0,null!==this.content&&"string"==typeof this.content&&null!==e&&(this.content=this.kt(e))}ci(t){return"string"==typeof t.content&&this.St()===t.content||"string"!=typeof t.content&&this.content===t.content}pi(t){return this.t===t.t&&this.hi.at===t.hi.at}fi(){return"reentryBehavior"in this.component?this.component.fi:"default"}mi(t){return("string"==typeof t.content&&this.St()===t.content||"string"!=typeof t.content&&this.content===t.content)&&this.t===t.t}wi(t){0===this.oi&&(this.li||(this.component=this.di(t)),this.oi=1)}gi(){1===this.oi&&(this.oi=0)}vi(t,s){if(!this.component)return Promise.resolve(0);if(!this.component.vi)return Promise.resolve(1);const i=mergeParameters(this.t,this.hi.at,this.content.t);this.hi.t=i.i,this.hi.o=i.o;const e=this.component.vi(i.l,this.hi,s);return Reporter.write(1e4,"viewport canEnter",e),"boolean"==typeof e?Promise.resolve(e):"string"==typeof e?Promise.resolve([new ViewportInstruction(e,t)]):e}yi(t){if(!this.component||!this.component.yi)return Promise.resolve(1);const s=this.component.yi(this.hi,t);return Reporter.write(1e4,"viewport canLeave",s),"boolean"==typeof s?Promise.resolve(s):s}async ri(t){if(this.ui||1===this.oi&&!this.ai){if(this.component.ri){const s=mergeParameters(this.t,this.hi.at,this.content.t);this.hi.t=s.i,this.hi.o=s.o,await this.component.ri(s.l,this.hi,t)}this.ai=1}}async Ci(t){4===this.oi&&this.ai&&(this.component.Ci&&await this.component.Ci(this.hi,t),this.ai=0)}loadComponent(t,s){if(1===this.oi&&this.ai)return this.li||Controller.Ri(this.component,t,s),this.oi=2,Promise.resolve()}Ei(){2===this.oi&&(this.oi=1)}bi(){2===this.oi&&(this.li||this.component.Si.bind(5120,null),this.oi=3)}Ii(t=0){3===this.oi&&(t||(this.component.Si.Vi(10240),this.oi=2))}addComponent(t){if(3===this.oi){if(this.component.Si.$i(1024),this.li){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)if(t.hasAttribute("au-element-scroll")){const[s,i]=t.getAttribute("au-element-scroll").split(",");t.removeAttribute("au-element-scroll"),t.scrollTo(+i,+s)}}this.oi=4}}Hi(t,s=0){if(4===this.oi&&!this.ai){if(s){const s=Array.from(t.getElementsByTagName("*"));for(const t of s)(t.scrollTop>0||t.scrollLeft)&&t.setAttribute("au-element-scroll",`${t.scrollTop},${t.scrollLeft}`)}this.component.Si.detach(2048),this.oi=3}}async Ni(t,s,i=0){switch(this.oi){case 4:await this.Ci(s),this.Hi(t,i);case 3:this.Ii(i);case 2:this.Ei();case 1:this.gi()}}St(){return null===this.content?null:"string"==typeof this.content?this.content:this.content.description.name}kt(t){if(null===this.content)return null;if("string"!=typeof this.content)return this.content;{const s=t.get(IContainer),i=s._t(CustomElementResource.At(this.content));return null!==i?i.Lt(s).Tt:null}}di(t){if(null===this.content)return null;const component=this.St();return t.get(IContainer).get("string"!=typeof component?component:CustomElementResource.At(component))}}class Viewport{constructor(router,name,t,s,i,e,n){this.router=router,this.name=name,this.Pi=t,this.context=s,this.Di=i,this.scope=e,this.options=n,this.clear=0,this.content=new ViewportContent,this.Oi=null,this.ki=null,this._i=null,this.cache=[],this.enabled=1}Ai(t,s){let i;if(this.clear=0,"string"==typeof t)if(t===this.router.ns.Bs)this.clear=1,t=null;else{const s=this.router.ns.hs(t);t=s.St,i=s.Vt}if(this.Oi=new ViewportContent(t,i,s,this.context),this.options.Ti){const t=this.cache.find(t=>this.Oi.mi(t));t?(this.Oi=t,this.Oi.li=1):this.cache.push(this.Oi)}return!this.content.ci(this.Oi)||s.Y||"refresh"===this.content.fi()?1:"disallow"!==this.content.fi()?this.content.pi(this.Oi)&&"enter"!==this.content.fi()?0:(this.content.ui=1,this.Oi.content=this.content.content,this.Oi.component=this.content.component,this.Oi.oi=this.content.oi,this.Oi.ui=this.content.ui,1):void 0}Li(t,s,i){this.scope&&this.scope.parent&&!this.scope.viewport&&(this.scope.viewport=this),this.scope&&!this.scope.Pi&&(this.scope.Pi=t),this.Pi!==t&&(this._i={...this},this.xi(),this.Pi=t,i&&i.Mi&&(this.options.Mi=i.Mi),i&&i.default&&(this.options.default=i.default),i&&i.Bi&&(this.options.Bi=i.Bi),i&&i.Qi&&(this.options.Qi=i.Qi),i&&i.Ti&&(this.options.Ti=i.Ti),this.ki&&this.ki()),s&&(s.It=this.name),this.context!==s&&(this.context=s),this.content.component||this.Oi&&this.Oi.component||!this.options.default||this.router.ji(this.options.default,this)}remove(t,s){return this.Pi===t&&this.context===s?(this.content.component&&this.content.Ni(this.Pi,this.Oi?this.Oi.hi:null,this.options.Ti).catch(t=>{throw t}),1):0}async yi(){return this.content.yi(this.Oi.hi)}async vi(){return this.clear?1:this.Oi.content?(await this.zi(),this.Oi.wi(this.context),this.Oi.vi(this,this.content.hi)):0}async ri(){return Reporter.write(1e4,"Viewport enter",this.name),this.clear?1:this.Oi&&this.Oi.component?(await this.Oi.ri(this.content.hi),await this.Oi.loadComponent(this.context,this.Pi),this.Oi.bi(),1):0}async qi(){return Reporter.write(1e4,"Viewport loadContent",this.name),this.content.component&&!this.Oi.component&&(await this.content.Ci(this.Oi.hi),this.content.Hi(this.Pi,this.options.Ti),this.content.Ii(this.options.Ti),this.content.Ei(),this.content.gi()),this.Oi.component&&(this.Oi.addComponent(this.Pi),this.content.component&&(await this.content.Ci(this.Oi.hi),this.content.ui||(this.content.Hi(this.Pi,this.options.Ti),this.content.Ii(this.options.Ti),this.content.Ei(),this.content.gi())),this.content=this.Oi,this.content.ui=0),this.clear&&(this.content=new ViewportContent(null,null,this.Oi.hi)),this.Oi=null,1}Ui(){this._i=null}async Gi(){await this.Oi.Ni(this.Pi,this.Oi?this.Oi.hi:null,this.options.Ti),this._i&&Object.assign(this,this._i)}description(t=0){if(this.content.content){const component=this.content.St();if(t||this.scope||this.options.Ji)return this.router.ns.js(new ViewportInstruction(component,this,this.content.t,null!==this.scope));const s=this.Di.Fi([new ViewportInstruction(component)]);return this.router.ns.js(new ViewportInstruction(component,s&&s.Wi&&s.Wi.length?null:this,this.content.t))}}Ki(t=0){const s=[this.Di.Xi(t),this.description(t)];return this.router.ns.Us(s.filter(value=>value&&value.length))}Yi(component){let t=this.options.Mi||[];return"string"==typeof t&&(t=t.split(",")),t.indexOf(component)>=0}Zi(component){if("-"===component||null===component)return 1;let t=this.options.Mi;return t&&t.length?("string"==typeof t&&(t=t.split(",")),0>t.indexOf(component)?t.filter(value=>value.indexOf("*")>=0).length?1:0:1):1}te(t){this.content.component&&this.content.bi()}se(t){Reporter.write(1e4,"ATTACHING viewport",this.name,this.content,this.Oi),this.enabled=1,this.content.component&&this.content.addComponent(this.Pi)}ie(t){Reporter.write(1e4,"DETACHING viewport",this.name),this.content.component&&this.content.Hi(this.Pi,this.options.Ti),this.enabled=0}ee(t){this.content.component&&this.content.Ii(this.options.Ti)}xi(){this.options={},this.content=new ViewportContent,this.cache=[]}async zi(){return this.Pi?Promise.resolve():new Promise(t=>{this.ki=t})}}class Scope{constructor(router,t,s,i){this.router=router,this.Pi=t,this.context=s,this.parent=i,this.viewport=null,this.children=[],this.ne=[],this.re=null,this.parent&&this.parent.he(this)}oe(){return this.ne.filter(t=>t.enabled).reduce((t,s)=>(t[s.name]=s,t),{})}Fi(t){const instructions=[];let s=0;t?(this.re={},this.Wi=t.slice()):this.Wi||(this.Wi=[]),this.re={...this.oe(),...this.re};for(let t=0;this.Wi.length>t;t++){const i=this.Wi[t];for(const name in this.re){const e=this.re[name];if(e&&e.Yi(i.St)){const n=this.ae(i,e);instructions.push(...n.Wi),s=s||n.le,this.re[name]=null,this.Wi.splice(t--,1);break}}}for(let t=0;this.Wi.length>t;t++){const i=this.Wi[t],name=i.It;if(!name||!name.length)continue;const e=i.Dt;this.oe()[name]||(this.ue(name,null,null,{scope:e,Ji:1}),this.re[name]=this.oe()[name]);const n=this.re[name];if(n&&n.Zi(i.St)){const e=this.ae(i,n);instructions.push(...e.Wi),s=s||e.le,this.re[name]=null,this.Wi.splice(t--,1)}}for(let t=0;this.Wi.length>t;t++){const i=this.Wi[t],e=[];for(const name in this.re){const t=this.re[name];t&&t.Zi(i.St)&&e.push(t)}if(1===e.length){const n=e.shift(),r=this.ae(i,n);instructions.push(...r.Wi),s=s||r.le,this.re[n.name]=null,this.Wi.splice(t,1);break}}if(s=s||this.Wi.length>0,!t)for(const t of this.children){const i=t.Fi();instructions.push(...i.Wi),s=s||i.le}return{Wi:instructions,le:s}}ae(t,s){t.Nt(s);const instructions=[t];let i=0;if(t.Ot){const e=(s.scope||s.Di).Fi([t.Ot]);instructions.push(...e.Wi),i=i||e.le}return{Wi:instructions,le:i}}ue(name,t,s,i){let e=this.oe()[name];if(t&&e&&null!==e.Pi&&e.Pi!==t&&(e.enabled=0,(e=this.ne.find(s=>s.name===name&&s.Pi===t))&&(e.enabled=1)),!e){let n;i.scope&&(n=new Scope(this.router,t,s,this),this.router.ce.push(n)),e=new Viewport(this.router,name,null,null,this,n,i),this.ne.push(e)}return(t||s)&&e.Li(t,s,i),e}pe(t,s,i){return(!s&&!i||t.remove(s,i))&&(t.scope&&this.router.fe(t.scope),this.ne.splice(this.ne.indexOf(t),1)),Object.keys(this.ne).length}fe(){for(const t of this.children)t.fe();const t=this.oe();for(const name in t)this.router.pe(t[name],null,null)}he(t){0>this.children.indexOf(t)&&this.children.push(t)}removeChild(t){this.children.splice(this.children.indexOf(t),1)}me(t=0,s=0){const i=[];for(const e in this.oe()){const n=this.oe()[e];(n.options.Qi||n.options.Bi&&!t)&&!s||i.push(n.Ki(t))}for(const s of this.children)i.push(...s.me(t));return i.filter(value=>value&&value.length)}Mt(){const t=this.ne.filter(t=>t.enabled);for(const s of this.children)t.push(...s.Mt());return t}Xi(t=0){if(!this.Pi||!this.parent)return"";const s=[];this.viewport&&s.unshift(this.viewport.description(t));let i=this.parent.we(this.context.get(IContainer).parent);for(;i&&i.Di===this.parent;)s.unshift(i.description(t)),i=this.we(i.context.get(IContainer).parent);return s.unshift(this.parent.Xi(t)),this.router.ns.Us(s.filter(value=>value&&value.length))}we(t){const s=Object.values(this.oe());for(;t;){const i=s.find(s=>s.context.get(IContainer)===t);if(i)return i;t=t.parent}return null}}const IRouteTransformer=DI.ge("IRouteTransformer").de(t=>t.singleton(RouteTable)),IRouter=DI.ge("IRouter").de(t=>t.singleton(Router));class Router{constructor(t,s,i,e,n){this.ce=[],this.ve={},this.rs=[],this.ye=[],this.v=0,this.Ce=[],this.Re=null,this.Ee=null,this.be=(t=>{let s=t.href;if(s.startsWith("#")&&(s=s.substring(1)),!s.startsWith("/")){const i=this.Se(t.anchor).Xi();s=this.ns.Gs(i,s)}this.Ie.dt(s)}),this.Wt=t,this.Ve=s,this.Ie=i,this.$e=e,this.ns=n}get He(){return null!==this.Re}V(t){if(this.v)throw Reporter.error(2001);return this.v=1,this.options={R:t=>{this.Ne(t)},Ys:this.Ve.Ys,Zs:this.Ve.Zs,...t},this.ns.V({Ts:this.options.Ts}),this.$e.V({R:this.be}),this.Ie.V(this.options).catch(t=>{throw t})}N(){if(!this.v)throw Reporter.error(2e3);this.$e.N(),this.Ie.N()}Ne(t){this.Ce.push(t),this.Pe().catch(t=>{throw t})}async Pe(){if(null!==this.Re||!this.Ce.length)return Promise.resolve();const t=this.Ce.shift();this.Re=t,this.options.De&&this.options.De(t);let s=0;(t.rt||t.nt)&&t.ot&&(t.path=t.ot,s=1);let i=t.path;if(this.options.Ys&&!s){const t=this.options.Ys(i,this);i=Array.isArray(t)?this.ns.as(t):t}const{Fs:e,Ws:n}=this.ns.Js(i);e&&(i=n);const r=parseQuery(t.at);t.t=r.t,t.o=r.list;const o=this.ns.es(i);if(!o&&!o.length&&!e)return this.Re=null,this.Pe();const a=e?this.Mt().filter(value=>null!==value.content.component):[],l=this.Mt().filter(value=>value.options.default&&null===value.content.component),u=[];let{Wi:c,le:p}=this.Oe.Fi(o),f=100;for(;c.length||p||l.length;){if(!f--)throw Reporter.error(2002);const s=[];for(const i of c){const e=i.viewport,n=this.ns.js(i,1);e.Ai(n,t)&&s.push(e);const r=a.findIndex(value=>value===e);0>r||a.splice(r,1);const o=l.findIndex(value=>value===e);0>o||l.splice(o,1)}for(const i of a)i.Ai(this.ns.Bs,t)&&s.push(i);let i;for(;i=l.shift();)i.Ai(i.options.default,t)&&s.push(i);let e=await Promise.all(s.map(value=>value.yi()));if(e.findIndex(value=>0==value)>=0)return this.ke([...s,...u],t);if((e=await Promise.all(s.map(async value=>{const t=await value.vi();if("boolean"==typeof t)return t?value.ri():0;for(const s of t)this.ji(s);return value.Gi().catch(t=>{throw t}),1}))).some(t=>0==t))return this.ke([...s,...u],t);for(const t of s)u.find(value=>value===t)||u.push(t);const n=this.Oe.Fi();let r;for(c=[];r=this.ye.shift();)n.Wi.find(value=>value.viewport===r.viewport)||c.push(r);c=[...c,...n.Wi],p=n.le}await Promise.all(u.map(value=>value.qi())),await this._e(t),t.ht||t.Ae||!u.every(t=>t.options.Qi)||await this.Ie.pop(),u.forEach(t=>{t.Ui()}),this.Ee=this.Re,this.Ee.Ae&&(this.Ee.Ae=0),this.Re=null,this.Pe().catch(t=>{throw t})}ji(t,s){this.Re?t instanceof ViewportInstruction?(t.viewport||(t.viewport=this.Mt().find(s=>s.name===t.It)),this.ye.push(t)):("string"==typeof s&&(s=this.Mt().find(t=>t.name===s)),this.ye.push(new ViewportInstruction(t,s))):this.Ee&&(this.Ce.unshift({path:"",ot:"",Ae:1}),this.Pe().catch(t=>{throw t}))}Te(t){return this.Le(),this.Se(t)}xe(name){return this.Mt().find(t=>t.name===name)}ue(name,t,s,i){return Reporter.write(1e4,"Viewport added",name,t),this.Te(t).ue(name,t,s,i)}pe(t,s,i){const e=t.Di;e.pe(t,s,i)||this.fe(e)}Mt(){return this.Le(),this.Oe.Mt()}fe(t){if(t!==this.Oe){t.fe();const s=this.ce.indexOf(t);0>s||this.ce.splice(s,1)}}pt(t,s,i){if("string"==typeof t)return this.Ie.pt(t,s,i)}replace(t,s,i){if("string"==typeof t)return this.Ie.replace(t,s,i)}refresh(){return this.Ie.refresh()}back(){return this.Ie.back()}forward(){return this.Ie.forward()}Me(name,t){const s=this.Be(name);s&&(s.ls=[]),this.Qe(name,t)}Qe(name,t){let s=this.ve[name];s||(s=this.ve[name]=new Nav(this,name)),s.us(t),this.ve[name]=new Nav(s.router,s.name,s.ls)}Be(name){return this.ve[name]}async ke(t,s){t.forEach(t=>{t.Gi().catch(t=>{throw t})}),s.G?await this.Ie.pop():await this.Ie.cancel(),this.Re=null,this.Pe().catch(t=>{throw t})}Le(){if(!this.Oe){const t=this.Wt.get(Aurelia).root;this.Oe=new Scope(this,t.host,t.controller.context,null),this.ce.push(this.Oe)}}Se(t){let s=t;for(;s.parentElement;){const t=this.Mt().find(t=>t.Pi===s);if(t&&t.Di)return t.Di;s=s.parentElement}return this.Oe}_e(t){this.rs=this.Oe.me(1,1),this.rs=this.ns.Ks(this.rs);let s=this.Oe.me();s=this.ns.Ks(s);let i=this.ns.Xs(s);if(this.options.Zs){const t=this.options.Zs(this.ns.es(i),this);i=Array.isArray(t)?this.ns.as(t):t}let e=this.Oe.me(1);e=this.ns.Ks(e);const n=t.at&&t.at.length?`?${t.at}`:"";return this.Ie.wt(i+n,this.ns.Xs(e,1)+n,t)}}Router.inject=[IContainer,IRouteTransformer,HistoryBrowser,LinkHandler,InstructionResolver];let NavCustomElement=class{constructor(router){this.router=router,this.name=null,this.ls=null,this.level=0}get je(){const t=this.router.ve[this.name];return t?t.ls:[]}active(t){return"Active"}};__decorate([bindable],NavCustomElement.prototype,"name",void 0),__decorate([bindable],NavCustomElement.prototype,"routes",void 0),__decorate([bindable],NavCustomElement.prototype,"level",void 0),NavCustomElement=__decorate([inject(Router,INode),customElement({name:"au-nav",template:'<template>\n  <nav if.bind="name" class="${name}">\n    <au-nav routes.bind="navRoutes" containerless></au-nav>\n  </nav>\n  <ul if.bind="routes" class="nav-level-${level}">\n    <li repeat.for="route of routes" class="${route.active} ${route.hasChildren}">\n      <a if.bind="route.link && route.link.length" href="${route.link}">${route.title}</a>\n      <a if.bind="!route.link || !route.link.length" click.delegate="route.toggleActive()" href="">${route.title}</a>\n      <au-nav if.bind="route.children" routes.bind="route.children" level.bind="level + 1" containerless></au-nav>\n    </li>\n  </ul>\n</template>'})],NavCustomElement);class ViewportCustomElement{constructor(router,t,s){this.name="default",this.scope=null,this.Mi=null,this.default=null,this.Bi=null,this.Qi=null,this.Ti=null,this.viewport=null,this.router=router,this.Pi=t,this.ze=s}qe(t,host,parts,s){const i=this.constructor,dom=s.get(IDOM),template=this.ze.Ue(dom,i.description,s,i);template.Ge=createRenderContext(dom,s,i.description.dependencies,i),template.qe(this,host,parts)}bound(){this.connect()}Je(){this.disconnect()}connect(){const t={scope:this.Pi.hasAttribute("scope")};this.Mi&&this.Mi.length&&(t.Mi=this.Mi),this.default&&this.default.length&&(t.default=this.default),this.Pi.hasAttribute("no-link")&&(t.Bi=1),this.Pi.hasAttribute("no-history")&&(t.Qi=1),this.Pi.hasAttribute("stateful")&&(t.Ti=1),this.viewport=this.router.ue(this.name,this.Pi,this.Si.context,t)}disconnect(){this.router.pe(this.viewport,this.Pi,this.Si.context)}te(t){this.viewport&&this.viewport.te(t)}se(t){this.viewport&&this.viewport.se(t)}ie(t){this.viewport&&this.viewport.ie(t)}ee(t){this.viewport&&this.viewport.ee(t)}}ViewportCustomElement.inject=[Router,INode,IRenderingEngine],__decorate([bindable],ViewportCustomElement.prototype,"name",void 0),__decorate([bindable],ViewportCustomElement.prototype,"scope",void 0),__decorate([bindable],ViewportCustomElement.prototype,"usedBy",void 0),__decorate([bindable],ViewportCustomElement.prototype,"default",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noLink",void 0),__decorate([bindable],ViewportCustomElement.prototype,"noHistory",void 0),__decorate([bindable],ViewportCustomElement.prototype,"stateful",void 0),CustomElementResource.Fe({name:"au-viewport",template:'<template><div class="viewport-header"> Viewport: <b>${name}</b> ${scope ? "[new scope]" : ""} : <b>${viewport.content && viewport.content.componentName()}</b></div></template>'},ViewportCustomElement);const RouterRegistration=Router,DefaultComponents=[Router],ViewportCustomElementRegistration=ViewportCustomElement,NavCustomElementRegistration=NavCustomElement,DefaultResources=[ViewportCustomElement,NavCustomElement],RouterConfiguration={register:t=>t.register(...DefaultComponents,...DefaultResources),We(){return this.register(DI.We())}};export{CharSpec,ContentStatus,DefaultComponents,DefaultResources,DynamicSegment,EpsilonSegment,HandlerEntry,HistoryBrowser,IRouteTransformer,IRouter,LinkHandler,Nav,NavCustomElement,NavCustomElementRegistration,QueuedBrowserHistory,RecognizeResult,ReentryBehavior,RouteGenerator,RouteRecognizer,Router,RouterConfiguration,RouterRegistration,Scope,StarSegment,State,StaticSegment,TypesRecord,Viewport,ViewportContent,ViewportCustomElement,ViewportCustomElementRegistration,ViewportInstruction};
